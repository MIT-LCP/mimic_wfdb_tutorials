
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Extracting BP values &#8212; MIMIC WFDB Tutorials</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorial/notebooks/extracting-reference-bp';</script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Case Study" href="../../case-study.html" />
    <link rel="prev" title="Pulse Wave Analysis" href="pulse-wave-analysis.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/icon.png" class="logo__image only-light" alt="MIMIC WFDB Tutorials - Home"/>
    <script>document.write(`<img src="../../_static/icon.png" class="logo__image only-dark" alt="MIMIC WFDB Tutorials - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Overview
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../workshop.html">Workshop</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../workshop/aims.html">Aims</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../workshop/synopsis.html">Synopsis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../workshop/schedule.html">Schedule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../workshop/prep.html">Preparation</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../mimic-database.html">MIMIC Database</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../mimic/physionet.html">PhysioNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mimic/context.html">Clinical Context</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mimic/structure.html">Database Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mimic/formatting.html">Waveform Data Formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mimic/wfdb-toolbox.html">WFDB Toolbox</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../../tutorials.html">Tutorials</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="data-exploration.html">Data Exploration</a></li>
<li class="toctree-l2"><a class="reference internal" href="data-extraction.html">Data Extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="data-visualisation.html">Data Visualisation</a></li>
<li class="toctree-l2"><a class="reference internal" href="signal-filtering.html">Filtering Signals</a></li>
<li class="toctree-l2"><a class="reference internal" href="differentiation.html">Differentiating the PPG signal</a></li>
<li class="toctree-l2"><a class="reference internal" href="beat-detection.html">Beat detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="pulse-wave-analysis.html">Pulse Wave Analysis</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Extracting BP values</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../case-study.html">Case Study</a></li>

<li class="toctree-l1"><a class="reference internal" href="../../additional-resources.html">Additional Resources</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../about.html">About this Book</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../about/about-contributing.html">How to Contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../about/about-maintenance.html">Maintenance</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorials-for-the-future.html">Future Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="qrs-detection.html">QRS peak detection</a></li>




<li class="toctree-l2"><a class="reference internal" href="../signal-quality-assessment.html">Signal Quality Assessment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data-modelling.html">Data modelling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data-analysis.html">Data analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data-interpretation.html">Data interpretation</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/wfdb/mimic_wfdb_tutorials/main?urlpath=tree/content/tutorial/notebooks/extracting-reference-bp.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/wfdb/mimic_wfdb_tutorials/blob/main/content/tutorial/notebooks/extracting-reference-bp.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/wfdb/mimic_wfdb_tutorials" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/wfdb/mimic_wfdb_tutorials/edit/main/content/tutorial/notebooks/extracting-reference-bp.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/wfdb/mimic_wfdb_tutorials/issues/new?title=Issue%20on%20page%20%2Ftutorial/notebooks/extracting-reference-bp.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/tutorial/notebooks/extracting-reference-bp.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Extracting BP values</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-one-minute-of-abp-signal-from-this-segment">Extract one minute of ABP signal from this segment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#derive-bp-values">Derive BP values</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#detect-beats-in-the-bp-signal">Detect beats in the BP signal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#detect-pulse-onsets-and-peaks">Detect pulse onsets and peaks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-bp-values">Calculate BP values</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#beat-detection-functions">Beat Detection Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fiducial-point-functions">Fiducial Point functions</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="extracting-bp-values">
<h1>Extracting BP values<a class="headerlink" href="#extracting-bp-values" title="Link to this heading">#</a></h1>
<p>In this tutorial we will extract reference blood pressure (BP) values from an arterial blood pressure (ABP) signal.</p>
<p>The <strong>objectives</strong> are:</p>
<ul class="simple">
<li><p>To extract an ABP signal from a segment</p></li>
<li><p>To identify beats in the ABP signal</p></li>
<li><p>To identify pulse onsets and peaks in the ABP signal</p></li>
<li><p>To derive reference systolic, diastolic and mean BP values from the ABP signal</p></li>
</ul>
<div class="alert alert-block alert-warning"> <b>Context:</b>
    There are two potential approaches to obtain reference BP values:
    <ol>
      <li>Obtaining BPs directly from numerics data:</li> The MIMIC Waveform Database contains 'numerics' data, which is the numerical values which the patient monitor derives from the waveforms and displays on the screen. This approach has the advantage that no signal processing is required, but the disadvantages that it involves reading additional numerics files, and that we don't know how these values are derived by the monitor (since the algorithms are proprietary).
      <li>Obtaining BPs from the ABP signal:</li> This has the advantage that no additional files are required, since all signals are stored in the same file. However, it does involve signal processing to obtain the values from the ABP signal.
    </ol>
</div><section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Link to this heading">#</a></h2>
<p><em>These steps have been covered in previous tutorials, so we’ll just re-use the code here.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Packages</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span><span class="nv">wfdb</span><span class="o">==</span><span class="m">4</span>.0.0
<span class="kn">import</span> <span class="nn">wfdb</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: wfdb==4.0.0 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (4.0.0)
Requirement already satisfied: SoundFile&lt;0.12.0,&gt;=0.10.0 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from wfdb==4.0.0) (0.11.0)
Requirement already satisfied: matplotlib&lt;4.0.0,&gt;=3.2.2 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from wfdb==4.0.0) (3.5.2)
Requirement already satisfied: numpy&lt;2.0.0,&gt;=1.10.1 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from wfdb==4.0.0) (1.26.4)
Requirement already satisfied: pandas&lt;2.0.0,&gt;=1.0.0 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from wfdb==4.0.0) (1.5.3)
Requirement already satisfied: requests&lt;3.0.0,&gt;=2.8.1 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from wfdb==4.0.0) (2.32.3)
Requirement already satisfied: scipy&lt;2.0.0,&gt;=1.0.0 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from wfdb==4.0.0) (1.14.0)
Requirement already satisfied: cycler&gt;=0.10 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from matplotlib&lt;4.0.0,&gt;=3.2.2-&gt;wfdb==4.0.0) (0.12.1)
Requirement already satisfied: fonttools&gt;=4.22.0 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from matplotlib&lt;4.0.0,&gt;=3.2.2-&gt;wfdb==4.0.0) (4.53.1)
Requirement already satisfied: kiwisolver&gt;=1.0.1 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from matplotlib&lt;4.0.0,&gt;=3.2.2-&gt;wfdb==4.0.0) (1.4.5)
Requirement already satisfied: packaging&gt;=20.0 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from matplotlib&lt;4.0.0,&gt;=3.2.2-&gt;wfdb==4.0.0) (24.1)
Requirement already satisfied: pillow&gt;=6.2.0 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from matplotlib&lt;4.0.0,&gt;=3.2.2-&gt;wfdb==4.0.0) (10.4.0)
Requirement already satisfied: pyparsing&gt;=2.2.1 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from matplotlib&lt;4.0.0,&gt;=3.2.2-&gt;wfdb==4.0.0) (3.1.2)
Requirement already satisfied: python-dateutil&gt;=2.7 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from matplotlib&lt;4.0.0,&gt;=3.2.2-&gt;wfdb==4.0.0) (2.9.0.post0)
Requirement already satisfied: pytz&gt;=2020.1 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from pandas&lt;2.0.0,&gt;=1.0.0-&gt;wfdb==4.0.0) (2024.1)
Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from requests&lt;3.0.0,&gt;=2.8.1-&gt;wfdb==4.0.0) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from requests&lt;3.0.0,&gt;=2.8.1-&gt;wfdb==4.0.0) (3.7)
Requirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from requests&lt;3.0.0,&gt;=2.8.1-&gt;wfdb==4.0.0) (2.2.2)
Requirement already satisfied: certifi&gt;=2017.4.17 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from requests&lt;3.0.0,&gt;=2.8.1-&gt;wfdb==4.0.0) (2024.7.4)
Requirement already satisfied: cffi&gt;=1.0 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from SoundFile&lt;0.12.0,&gt;=0.10.0-&gt;wfdb==4.0.0) (1.16.0)
Requirement already satisfied: pycparser in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from cffi&gt;=1.0-&gt;SoundFile&lt;0.12.0,&gt;=0.10.0-&gt;wfdb==4.0.0) (2.22)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: six&gt;=1.5 in /opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib&lt;4.0.0,&gt;=3.2.2-&gt;wfdb==4.0.0) (1.16.0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># MIMIC info</span>
<span class="n">database_name</span> <span class="o">=</span> <span class="s1">&#39;mimic4wdb/0.1.0&#39;</span> <span class="c1"># The name of the MIMIC IV Waveform Database on Physionet</span>

<span class="c1"># Segment for analysis</span>
<span class="n">segment_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;83404654_0005&#39;</span><span class="p">,</span> <span class="s1">&#39;82924339_0007&#39;</span><span class="p">,</span> <span class="s1">&#39;84248019_0005&#39;</span><span class="p">,</span> <span class="s1">&#39;82439920_0004&#39;</span><span class="p">,</span> <span class="s1">&#39;82800131_0002&#39;</span><span class="p">,</span> <span class="s1">&#39;84304393_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;89464742_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;88958796_0004&#39;</span><span class="p">,</span> <span class="s1">&#39;88995377_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;85230771_0004&#39;</span><span class="p">,</span> <span class="s1">&#39;86643930_0004&#39;</span><span class="p">,</span> <span class="s1">&#39;81250824_0005&#39;</span><span class="p">,</span> <span class="s1">&#39;87706224_0003&#39;</span><span class="p">,</span> <span class="s1">&#39;83058614_0005&#39;</span><span class="p">,</span> <span class="s1">&#39;82803505_0017&#39;</span><span class="p">,</span> <span class="s1">&#39;88574629_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;87867111_0012&#39;</span><span class="p">,</span> <span class="s1">&#39;84560969_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;87562386_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;88685937_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;86120311_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;89866183_0014&#39;</span><span class="p">,</span> <span class="s1">&#39;89068160_0002&#39;</span><span class="p">,</span> <span class="s1">&#39;86380383_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;85078610_0008&#39;</span><span class="p">,</span> <span class="s1">&#39;87702634_0007&#39;</span><span class="p">,</span> <span class="s1">&#39;84686667_0002&#39;</span><span class="p">,</span> <span class="s1">&#39;84802706_0002&#39;</span><span class="p">,</span> <span class="s1">&#39;81811182_0004&#39;</span><span class="p">,</span> <span class="s1">&#39;84421559_0005&#39;</span><span class="p">,</span> <span class="s1">&#39;88221516_0007&#39;</span><span class="p">,</span> <span class="s1">&#39;80057524_0005&#39;</span><span class="p">,</span> <span class="s1">&#39;84209926_0018&#39;</span><span class="p">,</span> <span class="s1">&#39;83959636_0010&#39;</span><span class="p">,</span> <span class="s1">&#39;89989722_0016&#39;</span><span class="p">,</span> <span class="s1">&#39;89225487_0007&#39;</span><span class="p">,</span> <span class="s1">&#39;84391267_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;80889556_0002&#39;</span><span class="p">,</span> <span class="s1">&#39;85250558_0011&#39;</span><span class="p">,</span> <span class="s1">&#39;84567505_0005&#39;</span><span class="p">,</span> <span class="s1">&#39;85814172_0007&#39;</span><span class="p">,</span> <span class="s1">&#39;88884866_0005&#39;</span><span class="p">,</span> <span class="s1">&#39;80497954_0012&#39;</span><span class="p">,</span> <span class="s1">&#39;80666640_0014&#39;</span><span class="p">,</span> <span class="s1">&#39;84939605_0004&#39;</span><span class="p">,</span> <span class="s1">&#39;82141753_0018&#39;</span><span class="p">,</span> <span class="s1">&#39;86874920_0014&#39;</span><span class="p">,</span> <span class="s1">&#39;84505262_0010&#39;</span><span class="p">,</span> <span class="s1">&#39;86288257_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;89699401_0001&#39;</span><span class="p">,</span> <span class="s1">&#39;88537698_0013&#39;</span><span class="p">,</span> <span class="s1">&#39;83958172_0001&#39;</span><span class="p">]</span>
<span class="n">segment_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mimic4wdb/0.1.0/waves/p100/p10020306/83404654&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p101/p10126957/82924339&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p102/p10209410/84248019&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p109/p10952189/82439920&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p111/p11109975/82800131&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p113/p11392990/84304393&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p121/p12168037/89464742&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p121/p12173569/88958796&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p121/p12188288/88995377&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p128/p12872596/85230771&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p129/p12933208/86643930&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p130/p13016481/81250824&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p132/p13240081/87706224&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p136/p13624686/83058614&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p137/p13791821/82803505&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p141/p14191565/88574629&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p142/p14285792/87867111&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p143/p14356077/84560969&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p143/p14363499/87562386&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p146/p14695840/88685937&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p149/p14931547/86120311&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p151/p15174162/89866183&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p153/p15312343/89068160&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p153/p15342703/86380383&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p155/p15552902/85078610&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p156/p15649186/87702634&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p158/p15857793/84686667&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p158/p15865327/84802706&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p158/p15896656/81811182&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p159/p15920699/84421559&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p160/p16034243/88221516&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p165/p16566444/80057524&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p166/p16644640/84209926&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p167/p16709726/83959636&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p167/p16715341/89989722&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p168/p16818396/89225487&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p170/p17032851/84391267&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p172/p17229504/80889556&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p173/p17301721/85250558&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p173/p17325001/84567505&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p174/p17490822/85814172&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p177/p17738824/88884866&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p177/p17744715/80497954&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p179/p17957832/80666640&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p180/p18080257/84939605&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p181/p18109577/82141753&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p183/p18324626/86874920&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p187/p18742074/84505262&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p188/p18824975/86288257&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p191/p19126489/89699401&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p193/p19313794/88537698&#39;</span><span class="p">,</span> <span class="s1">&#39;mimic4wdb/0.1.0/waves/p196/p19619764/83958172&#39;</span><span class="p">]</span>

<span class="n">rel_segment_no</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># 3 and 8 are helpful</span>
<span class="n">rel_segment_name</span> <span class="o">=</span> <span class="n">segment_names</span><span class="p">[</span><span class="n">rel_segment_no</span><span class="p">]</span>
<span class="n">rel_segment_dir</span> <span class="o">=</span> <span class="n">segment_dirs</span><span class="p">[</span><span class="n">rel_segment_no</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="extract-one-minute-of-abp-signal-from-this-segment">
<h2>Extract one minute of ABP signal from this segment<a class="headerlink" href="#extract-one-minute-of-abp-signal-from-this-segment" title="Link to this heading">#</a></h2>
<p><em>These steps have been covered in previous tutorials, so we’ll just re-use the code here.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_seconds</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># time since the start of the segment at which to begin extracting data</span>
<span class="n">no_seconds_to_load</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">segment_metadata</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdheader</span><span class="p">(</span><span class="n">record_name</span><span class="o">=</span><span class="n">rel_segment_name</span><span class="p">,</span> <span class="n">pn_dir</span><span class="o">=</span><span class="n">rel_segment_dir</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metadata loaded from segment: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rel_segment_name</span><span class="p">))</span>
<span class="n">fs</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">segment_metadata</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
<span class="n">sampfrom</span> <span class="o">=</span> <span class="n">fs</span><span class="o">*</span><span class="n">start_seconds</span>
<span class="n">sampto</span> <span class="o">=</span> <span class="n">fs</span><span class="o">*</span><span class="p">(</span><span class="n">start_seconds</span><span class="o">+</span><span class="n">no_seconds_to_load</span><span class="p">)</span>
<span class="n">segment_data</span> <span class="o">=</span> <span class="n">wfdb</span><span class="o">.</span><span class="n">rdrecord</span><span class="p">(</span><span class="n">record_name</span><span class="o">=</span><span class="n">rel_segment_name</span><span class="p">,</span> <span class="n">sampfrom</span><span class="o">=</span><span class="n">sampfrom</span><span class="p">,</span> <span class="n">sampto</span><span class="o">=</span><span class="n">sampto</span><span class="p">,</span> <span class="n">pn_dir</span><span class="o">=</span><span class="n">rel_segment_dir</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> seconds of data extracted from: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">no_seconds_to_load</span><span class="p">,</span> <span class="n">rel_segment_name</span><span class="p">))</span>
<span class="n">abp_col</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ppg_col</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">sig_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">segment_data</span><span class="o">.</span><span class="n">sig_name</span><span class="p">)):</span>
    <span class="k">if</span> <span class="s2">&quot;ABP&quot;</span> <span class="ow">in</span> <span class="n">segment_data</span><span class="o">.</span><span class="n">sig_name</span><span class="p">[</span><span class="n">sig_no</span><span class="p">]:</span>
        <span class="n">abp_col</span> <span class="o">=</span> <span class="n">sig_no</span>
<span class="n">abp</span> <span class="o">=</span> <span class="n">segment_data</span><span class="o">.</span><span class="n">p_signal</span><span class="p">[:,</span><span class="n">abp_col</span><span class="p">]</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">segment_data</span><span class="o">.</span><span class="n">fs</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extracted the ABP signal from column </span><span class="si">{}</span><span class="s2"> of the matrix of waveform data at </span><span class="si">{:.1f}</span><span class="s2"> Hz.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">abp_col</span><span class="p">,</span> <span class="n">fs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Metadata loaded from segment: 88995377_0001
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>20 seconds of data extracted from: 88995377_0001
Extracted the ABP signal from column 3 of the matrix of waveform data at 62.5 Hz.
</pre></div>
</div>
</div>
</div>
</section>
<hr class="docutils" />
<section id="derive-bp-values">
<h2>Derive BP values<a class="headerlink" href="#derive-bp-values" title="Link to this heading">#</a></h2>
<p>Derive BP values from the ABP signal</p>
<section id="detect-beats-in-the-bp-signal">
<h3>Detect beats in the BP signal<a class="headerlink" href="#detect-beats-in-the-bp-signal" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Import the functions required to detect beats by running the cell containing the required functions below.</p></li>
</ul>
<ul class="simple">
<li><p>Detect beats in the ABP signal:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">temp_fs</span> <span class="o">=</span> <span class="mi">125</span>
<span class="n">alg</span> <span class="o">=</span> <span class="s1">&#39;d2max&#39;</span>
<span class="n">pks</span> <span class="o">=</span> <span class="n">pulse_detect</span><span class="p">(</span><span class="n">abp</span><span class="p">,</span><span class="n">temp_fs</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">alg</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detected </span><span class="si">{}</span><span class="s2"> beats in the ABP signal using the </span><span class="si">{}</span><span class="s2"> algorithm&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pks</span><span class="p">),</span> <span class="n">alg</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">line</span> <span class="mi">3</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">temp_fs</span> <span class="o">=</span> <span class="mi">125</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">alg</span> <span class="o">=</span> <span class="s1">&#39;d2max&#39;</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">pks</span> <span class="o">=</span> <span class="n">pulse_detect</span><span class="p">(</span><span class="n">abp</span><span class="p">,</span><span class="n">temp_fs</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">alg</span><span class="p">)</span>
<span class="nn">      4 print(&quot;Detected {} beats</span> in <span class="ni">the ABP signal using the {} algorithm&quot;.format(len</span><span class="nt">(pks), alg))</span>

<span class="ne">NameError</span>: name &#39;pulse_detect&#39; is not defined
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Make a plot showing the ABP signal and the beats detected</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">abp</span><span class="p">)</span><span class="o">/</span><span class="n">fs</span><span class="p">),</span><span class="mf">1.0</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
<span class="n">line1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">abp</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ABP&#39;</span><span class="p">)</span>
<span class="n">line2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">((</span><span class="n">pks</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">fs</span><span class="p">),</span> <span class="n">abp</span><span class="p">[</span><span class="n">pks</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;peaks&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6f3916339a251108f80e85761f14614522667fe626cc9123305138992123974c.png" src="../../_images/6f3916339a251108f80e85761f14614522667fe626cc9123305138992123974c.png" />
</div>
</div>
</section>
<section id="detect-pulse-onsets-and-peaks">
<h3>Detect pulse onsets and peaks<a class="headerlink" href="#detect-pulse-onsets-and-peaks" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Import the functions required to detect fiducial points by running the cell containing the required functions below.</p></li>
</ul>
<ul class="simple">
<li><p>Detect fiducial points:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fidp</span> <span class="o">=</span> <span class="n">fiducial_points</span><span class="p">(</span><span class="n">abp</span><span class="p">,</span><span class="n">pks</span><span class="p">,</span><span class="n">temp_fs</span><span class="p">,</span><span class="n">vis</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Plot the ABP signal and the pulse peaks and onsets:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pks</span> <span class="o">=</span> <span class="n">fidp</span><span class="p">[</span><span class="s2">&quot;pks&quot;</span><span class="p">]</span>
<span class="n">ons</span> <span class="o">=</span> <span class="n">fidp</span><span class="p">[</span><span class="s2">&quot;ons&quot;</span><span class="p">]</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">abp</span><span class="p">)</span><span class="o">/</span><span class="n">fs</span><span class="p">),</span><span class="mf">1.0</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">abp</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">pks</span><span class="p">],</span> <span class="n">abp</span><span class="p">[</span><span class="n">pks</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">ons</span><span class="p">],</span> <span class="n">abp</span><span class="p">[</span><span class="n">ons</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7faecc631760&gt;]
</pre></div>
</div>
<img alt="../../_images/94a8408eaca05ea776209dc14e357aceb24c193f4c3ce9f5115c91d07f5202d9.png" src="../../_images/94a8408eaca05ea776209dc14e357aceb24c193f4c3ce9f5115c91d07f5202d9.png" />
</div>
</div>
</section>
<section id="calculate-bp-values">
<h3>Calculate BP values<a class="headerlink" href="#calculate-bp-values" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Extract systolic and diastolic BPs:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sbp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">abp</span><span class="p">[</span><span class="n">fidp</span><span class="p">[</span><span class="s1">&#39;pks&#39;</span><span class="p">]])</span>
<span class="n">dbp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">abp</span><span class="p">[</span><span class="n">fidp</span><span class="p">[</span><span class="s1">&#39;ons&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Extract mean BPs:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ons</span> <span class="o">=</span> <span class="n">fidp</span><span class="p">[</span><span class="s1">&#39;ons&#39;</span><span class="p">]</span>
<span class="n">off</span> <span class="o">=</span> <span class="n">fidp</span><span class="p">[</span><span class="s1">&#39;off&#39;</span><span class="p">]</span>
<span class="n">mbps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ons</span><span class="p">))</span>
<span class="k">for</span> <span class="n">beat_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ons</span><span class="p">)):</span>
    <span class="n">mbps</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">abp</span><span class="p">[</span><span class="n">ons</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]:</span><span class="n">off</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]])</span>
<span class="n">mbp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">mbps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Print results:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Systolic blood pressure  (SBP): </span><span class="si">{:.1f}</span><span class="s1"> mmHg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sbp</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Diastolic blood pressure (DBP): </span><span class="si">{:.1f}</span><span class="s1"> mmHg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dbp</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean blood pressure      (MBP): </span><span class="si">{:.1f}</span><span class="s1"> mmHg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mbp</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Systolic blood pressure  (SBP): 161.9 mmHg
Diastolic blood pressure (DBP): 67.2 mmHg
Mean blood pressure      (MBP): 102.5 mmHg
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-warning"> <b>Question:</b>
    Often MBP is approximated as: MBP = ((2/3)*DBP)+((1/3)*SBP).
    Would it have made much difference if we had used this approximation?
    What is the basis for this approximation?
</div></section>
</section>
<hr class="docutils" />
<section id="beat-detection-functions">
<h2>Beat Detection Functions<a class="headerlink" href="#beat-detection-functions" title="Link to this heading">#</a></h2>
<p>The following functions are required for this tutorial. Run the cell below and then return to the top of the page.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">pulse_detect</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">alg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Pulse detection and correction from pulsatile signals</span>
<span class="sd">    Inputs:  x, array with pulsatile signal [user defined units]</span>
<span class="sd">             fs, sampling rate of signal [Hz]</span>
<span class="sd">             w, window length for analysis [s]</span>
<span class="sd">             alg, string with the name of the algorithm to apply [&#39;heartpy&#39;,&#39;d2max&#39;,&#39;upslopes&#39;,&#39;delineator&#39;]</span>
<span class="sd">    Outputs: ibis, location of cardiac cycles as detected by the selected algorithm [number of samples]</span>

<span class="sd">    Algorithms:       1: HeartPy (van Gent et al, 2019, DOI: 10.1016/j.trf.2019.09.015)</span>
<span class="sd">                      2: 2nd derivative maxima (Elgendi et al, 2013, DOI: 10.1371/journal.pone.0076585)</span>
<span class="sd">                      3: Systolic upslopes (Arguello Prada and Serna Maldonado, 2018,</span>
<span class="sd">                         DOI: 10.1080/03091902.2019.1572237)</span>
<span class="sd">                      4: Delineator (Li et al, 2010, DOI: 10.1109/TBME.2005.855725)</span>
<span class="sd">    Fiducial points:  1: Systolic peak (pks)</span>
<span class="sd">                      2: Onset, as the minimum before the systolic peak (ons)</span>
<span class="sd">                      3: Onset, using the tangent intersection method (ti)</span>
<span class="sd">                      4: Diastolic peak (dpk)</span>
<span class="sd">                      5: Maximum slope (m1d)</span>
<span class="sd">                      6: a point from second derivative PPG (a2d)</span>
<span class="sd">                      7: b point from second derivative PPG (b2d)</span>
<span class="sd">                      8: c point from second derivative PPG (c2d)</span>
<span class="sd">                      9: d point from second derivative PPG (d2d)</span>
<span class="sd">                      10: e point from second derivative PPG (e2d)</span>
<span class="sd">                      11: p1 from the third derivative PPG (p1)</span>
<span class="sd">                      12: p2 from the third derivative PPG (p2)</span>

<span class="sd">    Libraries: NumPy (as np), SciPy (Signal, as sp), Matplotlib (PyPlot, as plt)</span>

<span class="sd">    Version: 1.0 - June 2022</span>

<span class="sd">    Developed by: Elisa Mejía-Mejía</span>
<span class="sd">                   City, University of London</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check selected algorithm</span>
    <span class="n">pos_alg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;heartpy&#39;</span><span class="p">,</span><span class="s1">&#39;d2max&#39;</span><span class="p">,</span><span class="s1">&#39;upslopes&#39;</span><span class="p">,</span><span class="s1">&#39;delineator&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">alg</span> <span class="ow">in</span> <span class="n">pos_alg</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unknown algorithm determined. Using D2max as default&#39;</span><span class="p">)</span>
        <span class="n">alg</span> <span class="o">=</span> <span class="s1">&#39;d2max&#39;</span>

    <span class="c1"># Pre-processing of signal</span>
    <span class="n">x_d</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">sos</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">btype</span> <span class="o">=</span> <span class="s1">&#39;bp&#39;</span><span class="p">,</span> <span class="n">analog</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;sos&#39;</span><span class="p">,</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">x_f</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sosfiltfilt</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="n">x_d</span><span class="p">)</span>

    <span class="c1"># Peak detection in windows of length w</span>
    <span class="n">n_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_f</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">fs</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_int</span><span class="p">)):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">fs</span><span class="o">*</span><span class="n">w</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">fs</span><span class="o">*</span><span class="n">w</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1"># print(&#39;Start: &#39; + str(start) + &#39;, stop: &#39; + str(stop) + &#39;, fs: &#39; + str(fs))</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">x_f</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">alg</span> <span class="o">==</span> <span class="s1">&#39;heartpy&#39;</span><span class="p">:</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">heartpy</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">alg</span> <span class="o">==</span> <span class="s1">&#39;d2max&#39;</span><span class="p">:</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">d2max</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span><span class="n">fs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">alg</span> <span class="o">==</span> <span class="s1">&#39;upslopes&#39;</span><span class="p">:</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">upslopes</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">alg</span> <span class="o">==</span> <span class="s1">&#39;delineator&#39;</span><span class="p">:</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">delineator</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">locs</span> <span class="o">+</span> <span class="n">start</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ibis</span> <span class="o">=</span> <span class="n">locs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ibis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ibis</span><span class="p">,</span><span class="n">locs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_int</span><span class="o">*</span><span class="n">fs</span><span class="o">*</span><span class="n">w</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_f</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_f</span><span class="p">)</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">x_f</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">stop</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">alg</span> <span class="o">==</span> <span class="s1">&#39;heartpy&#39;</span><span class="p">:</span>
                <span class="n">locs</span> <span class="o">=</span> <span class="n">heartpy</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">alg</span> <span class="o">==</span> <span class="s1">&#39;d2max&#39;</span><span class="p">:</span>
                <span class="n">locs</span> <span class="o">=</span> <span class="n">d2max</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span><span class="n">fs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">alg</span> <span class="o">==</span> <span class="s1">&#39;upslopes&#39;</span><span class="p">:</span>
                <span class="n">locs</span> <span class="o">=</span> <span class="n">upslopes</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">alg</span> <span class="o">==</span> <span class="s1">&#39;delineator&#39;</span><span class="p">:</span>
                <span class="n">locs</span> <span class="o">=</span> <span class="n">delineator</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span><span class="n">fs</span><span class="p">)</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">locs</span> <span class="o">+</span> <span class="n">start</span>
            <span class="n">ibis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ibis</span><span class="p">,</span><span class="n">locs</span><span class="p">)</span>
    <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ibis</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_f</span><span class="p">))</span>
    <span class="n">ibis</span> <span class="o">=</span> <span class="n">ibis</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="n">ibis</span> <span class="o">=</span> <span class="n">peak_correction</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ibis</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">5</span><span class="p">,[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>

    <span class="c1">#fig = plt.figure()</span>
    <span class="c1">#plt.plot(x)</span>
    <span class="c1">#plt.plot(x_d)</span>
    <span class="c1">#plt.plot(x_f)</span>
    <span class="c1">#plt.scatter(ibis,x_f[ibis],marker = &#39;o&#39;,color = &#39;red&#39;)</span>
    <span class="c1">#plt.scatter(ibis,x[ibis],marker = &#39;o&#39;,color = &#39;red&#39;)</span>

    <span class="k">return</span> <span class="n">ibis</span>

<span class="k">def</span> <span class="nf">peak_correction</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">locs</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">stride</span><span class="p">,</span><span class="n">th_len</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Correction of peaks detected from pulsatile signals</span>

<span class="sd">    Inputs:   x, pulsatile signal [user defined units]</span>
<span class="sd">              locs, location of the detected interbeat intervals [number of samples]</span>
<span class="sd">              fs, sampling rate [Hz]</span>
<span class="sd">              t, duration of intervals for the correction [s]</span>
<span class="sd">              stride, stride between consecutive intervals for the correction [s]</span>
<span class="sd">              th_len, array with the percentage of lower and higher thresholds for comparing the duration of IBIs</span>
<span class="sd">              [proportions]</span>
<span class="sd">    Outputs:  ibis, array with the corrected points related to the start of the inter-beat intervals [number of samples]</span>

<span class="sd">    Developed by:  Elisa Mejía Mejía</span>
<span class="sd">                   City, University of London</span>
<span class="sd">    Version:       1.0 -   June, 2022</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#fig = plt.figure()</span>
    <span class="c1">#plt.plot(x)</span>
    <span class="c1">#plt.scatter(locs,x[locs],marker = &#39;o&#39;,color = &#39;red&#39;, label = &#39;Original&#39;)</span>
    <span class="c1">#plt.title(&#39;Peak correction&#39;)</span>

    <span class="c1"># Correction of long and short IBIs</span>
    <span class="n">len_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
    <span class="c1">#print(&#39;Window length: &#39; + str(len_window))</span>
    <span class="n">first_i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">second_i</span> <span class="o">=</span> <span class="n">len_window</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">second_i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">ind1</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">locs</span> <span class="o">&gt;=</span> <span class="n">first_i</span><span class="p">)</span>
        <span class="n">ind2</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">locs</span> <span class="o">&lt;=</span> <span class="n">second_i</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">)</span>

        <span class="n">win</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>
        <span class="c1">#print(&#39;Indices: &#39; + str(ind) + &#39;, locs: &#39; + str(locs[ind]) + &#39;, dif: &#39; + str(dif))</span>

        <span class="n">th_dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">th_dif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">th_len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dif</span><span class="p">)</span>
        <span class="n">th_dif</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">th_len</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dif</span><span class="p">)</span>

        <span class="n">th_amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">th_amp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.75</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">win</span><span class="p">])</span>
        <span class="n">th_amp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">win</span><span class="p">])</span>
        <span class="c1">#print(&#39;Length thresholds: &#39; + str(th_dif) + &#39;, amplitude thresholds: &#39; + str(th_amp))</span>

        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dif</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dif</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">th_dif</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">win</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">win</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">win</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optional: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">opt</span><span class="p">))</span>
                <span class="n">dif_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">opt</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dif</span><span class="p">))</span>
                <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dif_abs</span><span class="p">)</span>
                <span class="n">ind_min</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dif_abs</span> <span class="o">==</span> <span class="n">min_val</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_val</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, index: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ind_min</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ind_min</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Original window: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">win</span><span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">win</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;, modified window: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">win</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Original window: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">win</span><span class="p">),</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;, modified window: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">win</span><span class="p">))</span>
                <span class="n">dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dif</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">th_dif</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">aux_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span><span class="n">win</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
                <span class="n">locs_pks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">aux_x</span><span class="p">)</span>
                <span class="c1">#fig = plt.figure()</span>
                <span class="c1">#plt.plot(aux_x)</span>
                <span class="c1">#plt.scatter(locs_pks,aux_x[locs_pks],marker = &#39;o&#39;,color = &#39;red&#39;)</span>

                <span class="n">locs_pks</span> <span class="o">=</span> <span class="n">locs_pks</span> <span class="o">+</span> <span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">ind1</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">locs_pks</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">th_amp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">ind2</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">locs_pks</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">th_amp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">)</span>
                <span class="n">locs_pks</span> <span class="o">=</span> <span class="n">locs_pks</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="c1">#print(&#39;Locations: &#39; + str(locs_pks))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">locs_pks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="n">locs_pks</span> <span class="o">-</span> <span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

                    <span class="n">dif_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">opt</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dif</span><span class="p">))</span>
                    <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dif_abs</span><span class="p">)</span>
                    <span class="n">ind_min</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dif_abs</span> <span class="o">==</span> <span class="n">min_val</span><span class="p">)</span>

                    <span class="n">win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">locs_pks</span><span class="p">[</span><span class="n">ind_min</span><span class="p">])</span>
                    <span class="n">win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>
                    <span class="n">dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dif</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">opt</span> <span class="o">&lt;</span> <span class="n">win</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="n">win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">locs_pks</span><span class="p">[</span><span class="n">ind_min</span><span class="p">])</span>
                        <span class="n">win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>
                        <span class="n">dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">win</span><span class="p">)</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">win</span><span class="p">,</span> <span class="n">locs</span><span class="p">)</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span>

        <span class="n">first_i</span> <span class="o">=</span> <span class="n">first_i</span> <span class="o">+</span> <span class="n">stride</span><span class="o">*</span><span class="n">fs</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">second_i</span> <span class="o">=</span> <span class="n">second_i</span> <span class="o">+</span> <span class="n">stride</span><span class="o">*</span><span class="n">fs</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span>
    <span class="n">dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dif</span><span class="p">)</span>
    <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dif</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">locs</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

    <span class="c1">#plt.scatter(locs,x[locs],marker = &#39;o&#39;,color = &#39;green&#39;, label = &#39;After length correction&#39;)</span>

    <span class="c1"># Correction of points that are not peaks</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pre_loc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">locs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#print(&#39;Previous: &#39; + str(x[locs[i] - 1]) + &#39;, actual: &#39; + str(x[locs[i]]) + &#39;, next: &#39; + str(x[locs[i] + 1]))</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">[</span><span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">x</span><span class="p">[</span><span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="c1">#print(&#39;Condition: &#39; + str(cond))</span>
            <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">pre_loc</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">locs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">aux_loc</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">aux_start</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">locs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">aux_loc</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">aux_start</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">aux</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">locs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span><span class="n">locs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
                        <span class="n">aux_loc</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">aux_start</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="c1">#print(&#39;i &#39; + str(i) + &#39; out of &#39; + str(len(locs)) + &#39;, aux length: &#39; + str(len(aux)) +</span>
                    <span class="c1">#      &#39;, location: &#39; + str(aux_loc))</span>
                    <span class="c1">#print(&#39;Locs i - 1: &#39; + str(locs[i - 1]) + &#39;, locs i: &#39; + str(locs[i]) + &#39;, locs i + 1: &#39; + str(locs[i + 1]))</span>

                    <span class="n">pre</span> <span class="o">=</span> <span class="n">find_closest_peak</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span> <span class="n">aux_loc</span><span class="p">,</span> <span class="s1">&#39;backward&#39;</span><span class="p">)</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">find_closest_peak</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span> <span class="n">aux_loc</span><span class="p">,</span> <span class="s1">&#39;forward&#39;</span><span class="p">)</span>
                    <span class="c1">#print(&#39;Previous: &#39; + str(pre) + &#39;, next: &#39; + str(pos) + &#39;, actual: &#39; + str(aux_loc))</span>

                    <span class="n">ibi_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pre</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span> <span class="o">-</span> <span class="n">pre</span><span class="p">)</span>
                    <span class="n">ibi_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span> <span class="o">-</span> <span class="n">pos</span><span class="p">)</span>
                    <span class="n">ibi_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_loc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span> <span class="o">-</span> <span class="n">aux_loc</span><span class="p">)</span>
                    <span class="c1">#print(&#39;Previous IBIs: &#39; + str(ibi_pre) + &#39;, next IBIs: &#39; + str(ibi_pos) +</span>
                    <span class="c1">#      &#39;, actual IBIs: &#39; + str(ibi_act))</span>

                    <span class="n">dif_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ibi_pre</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">locs</span><span class="p">)))</span>
                    <span class="n">dif_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ibi_pos</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">locs</span><span class="p">)))</span>
                    <span class="n">dif_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ibi_act</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">locs</span><span class="p">)))</span>
                    <span class="c1">#print(&#39;Previous DIF: &#39; + str(dif_pre) + &#39;, next DIF: &#39; + str(dif_pos) +</span>
                    <span class="c1">#      &#39;, actual DIF: &#39; + str(dif_act))</span>

                    <span class="n">avgs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dif_pre</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dif_pos</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dif_act</span><span class="p">)]</span>
                    <span class="n">min_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">avgs</span><span class="p">)</span>
                    <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">min_avg</span> <span class="o">==</span> <span class="n">avgs</span><span class="p">)</span>
                    <span class="c1">#print(&#39;Averages: &#39; + str(avgs) + &#39;, min index: &#39; + str(ind))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pre</span> <span class="o">+</span> <span class="n">aux_start</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">ind</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">aux_start</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">ind</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">locs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux_loc</span> <span class="o">+</span> <span class="n">aux_start</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1">#plt.scatter(locs,x[locs],marker = &#39;o&#39;,color = &#39;yellow&#39;, label = &#39;After not-peak correction&#39;)</span>

    <span class="c1"># Correction of peaks according to amplitude</span>
    <span class="n">len_window</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
    <span class="c1">#print(&#39;Window length: &#39; + str(len_window))</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">first_i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">second_i</span> <span class="o">=</span> <span class="n">len_window</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">second_i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">ind1</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">locs</span> <span class="o">&gt;=</span> <span class="n">first_i</span><span class="p">)</span>
        <span class="n">ind2</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">locs</span> <span class="o">&lt;=</span> <span class="n">second_i</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">)</span>
        <span class="n">win</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">win</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">th_amp_low</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">win</span><span class="p">])</span>
            <span class="n">th_amp_high</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">win</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">th_amp_low</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">win</span><span class="p">])</span>
            <span class="n">th_amp_high</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">win</span><span class="p">])</span>
        <span class="n">ind1</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">win</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">th_amp_low</span><span class="p">)</span>
        <span class="n">ind2</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">win</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">th_amp_high</span><span class="p">)</span>
        <span class="n">aux_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span><span class="n">ind2</span><span class="p">)</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keep</span><span class="p">,</span> <span class="n">aux_keep</span><span class="p">)</span>

        <span class="n">first_i</span> <span class="o">=</span> <span class="n">second_i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">second_i</span> <span class="o">=</span> <span class="n">second_i</span> <span class="o">+</span> <span class="n">stride</span><span class="o">*</span><span class="n">fs</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">keep</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>

    <span class="c1">#plt.scatter(locs,x[locs],marker = &#39;o&#39;,color = &#39;purple&#39;, label = &#39;After amplitude correction&#39;)</span>
    <span class="c1">#plt.legend()</span>

    <span class="k">return</span> <span class="n">locs</span>

<span class="k">def</span> <span class="nf">find_closest_peak</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">dir_search</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the closest peak to the initial location in x</span>

<span class="sd">    Inputs:   x, signal of interest [user defined units]</span>
<span class="sd">              loc, initial location [number of samples]</span>
<span class="sd">              dir_search, direction of search [&#39;backward&#39;,&#39;forward&#39;]</span>
<span class="sd">    Outputs:  pos, location of the first peak detected in specified direction [number of samples]</span>

<span class="sd">    Developed by:  Elisa Mejía Mejía</span>
<span class="sd">                   City, University of London</span>
<span class="sd">    Version:       1.0 -   June, 2022</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">dir_search</span> <span class="o">==</span> <span class="s1">&#39;backward&#39;</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">loc</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">loc</span>
    <span class="k">elif</span> <span class="n">dir_search</span> <span class="o">==</span> <span class="s1">&#39;forward&#39;</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">loc</span>

    <span class="k">return</span> <span class="n">pos</span>

<span class="k">def</span> <span class="nf">seek_local</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="n">val_min</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">]</span>
    <span class="n">val_max</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">]</span>

    <span class="n">ind_min</span> <span class="o">=</span> <span class="n">start</span>
    <span class="n">ind_max</span> <span class="o">=</span> <span class="n">start</span>

    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">val_max</span><span class="p">:</span>
            <span class="n">val_max</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">ind_max</span> <span class="o">=</span> <span class="n">j</span>
        <span class="k">elif</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">val_min</span><span class="p">:</span>
            <span class="n">val_min</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">ind_min</span> <span class="o">=</span> <span class="n">j</span>

    <span class="k">return</span> <span class="n">val_min</span><span class="p">,</span> <span class="n">ind_min</span><span class="p">,</span> <span class="n">val_max</span><span class="p">,</span> <span class="n">ind_max</span>

<span class="k">def</span> <span class="nf">heartpy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">min_ihr</span><span class="p">,</span> <span class="n">max_ihr</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detects inter-beat intervals using HeartPy</span>
<span class="sd">    Citation: van Gent P, Farah H, van Nes N, van Arem B (2019) Heartpy: A novel heart rate algorithm</span>
<span class="sd">              for the analysis of noisy signals. Transp Res Part F, vol. 66, pp. 368-378. DOI: 10.1016/j.trf.2019.09.015</span>

<span class="sd">    Inputs:   x, pulsatile signal [user defined units]</span>
<span class="sd">              fs, sampling rate [Hz]</span>
<span class="sd">              min_ihr, minimum value of instantaneous heart rate to be accepted [bpm]</span>
<span class="sd">              max_ihr, maximum value of instantaneous heart rate to be accepted [bpm]</span>
<span class="sd">              w, length of segments for correction of peaks [s]</span>
<span class="sd">    Outputs:  ibis, position of the starting points of inter-beat intervals [number of samples]</span>

<span class="sd">    Developed by:  Elisa Mejía Mejía</span>
<span class="sd">                   City, University of London</span>
<span class="sd">    Version:       1.0 -   June, 2022</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Identification of peaks</span>
    <span class="n">is_roi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_rois</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pos_pks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">len_ma</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">0.75</span><span class="o">*</span><span class="n">fs</span><span class="p">))</span>
    <span class="c1">#print(len_ma)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len_ma</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">len_ma</span><span class="p">))</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">len_ma</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="o">-</span> <span class="n">len_ma</span><span class="p">:</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">len_ma</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">len_ma</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="c1">#print(len(sig[i - len_ma:i + len_ma - 1]),ma)</span>

        <span class="c1"># If it is the beginning of a new ROI:</span>
        <span class="k">if</span> <span class="n">is_roi</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ma</span><span class="p">:</span>
            <span class="n">is_roi</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">n_rois</span> <span class="o">=</span> <span class="n">n_rois</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1">#print(&#39;New ROI ---&#39; + str(n_rois) + &#39; @ &#39; + str(i))</span>
            <span class="c1"># If it is a peak:</span>
            <span class="k">if</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">pos_pks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_pks</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="c1">#print(&#39;Possible peaks: &#39; + str(pos_pks))</span>

        <span class="c1"># If it is part of a ROI which is not over:</span>
        <span class="k">elif</span> <span class="n">is_roi</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ma</span><span class="p">:</span>
            <span class="c1">#print(&#39;Actual ROI ---&#39; + str(n_rois) + &#39; @ &#39; + str(i))</span>
            <span class="c1"># If it is a peak:</span>
            <span class="k">if</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">sig</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">pos_pks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_pks</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="c1">#print(&#39;Possible peaks: &#39; + str(pos_pks))</span>

        <span class="c1"># If the ROI is over or the end of the signal has been reached:</span>
        <span class="k">elif</span> <span class="n">is_roi</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ma</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="o">-</span> <span class="n">len_ma</span><span class="p">)):</span>
            <span class="c1">#print(&#39;End of ROI ---&#39; + str(n_rois) + &#39; @ &#39; + str(i) + &#39;. Pos pks: &#39; + str(pos_pks))</span>
            <span class="n">is_roi</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Lowers flag</span>

            <span class="c1"># If it is the end of the first ROI:</span>
            <span class="k">if</span> <span class="n">n_rois</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># If at least one peak has been found:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_pks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Determines the location of the maximum peak:</span>
                    <span class="n">max_pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="n">pos_pks</span><span class="p">])</span>
                    <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_pk</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="n">pos_pks</span><span class="p">]))</span>
                    <span class="c1">#print(&#39;First ROI: (1) Max Peak: &#39; + str(max_pk) + &#39;, amplitudes: &#39; + str(sig[pos_pks]) +</span>
                    <span class="c1">#      &#39;, index: &#39; + str(int(ind)), &#39;, pk_ind: &#39; + str(pos_pks[ind]))</span>
                    <span class="c1"># The maximum peak is added to the list:</span>
                    <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">pos_pks</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                    <span class="c1">#print(&#39;Locations: &#39; + str(locs))</span>
                <span class="c1"># If no peak was found:</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Counter for ROIs is reset to previous value:</span>
                    <span class="n">n_rois</span> <span class="o">=</span> <span class="n">n_rois</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="c1"># If it is the end of the second ROI:</span>
            <span class="k">elif</span> <span class="n">n_rois</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># If at least one peak has been found:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_pks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Measures instantantaneous HR of found peaks with respect to the previous peak:</span>
                    <span class="n">ihr</span> <span class="o">=</span> <span class="mi">60</span><span class="o">/</span><span class="p">((</span><span class="n">pos_pks</span> <span class="o">-</span> <span class="n">locs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
                    <span class="n">good_ihr</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ihr</span> <span class="o">&lt;=</span> <span class="n">max_ihr</span> <span class="ow">and</span> <span class="n">ihr</span> <span class="o">&gt;=</span> <span class="n">min_ihr</span><span class="p">)</span>
                    <span class="c1">#print(&#39;Second ROI IHR check: (1) IHR: &#39; + str(ihr) + &#39;, valid peaks: &#39; + str(good_ihr) +</span>
                    <span class="c1">#      &#39;, pos_pks before: &#39; + str(pos_pks) + &#39;, pos_pks after: &#39; + str(pos_pks[good_ihr]))</span>
                    <span class="n">pos_pks</span> <span class="o">=</span> <span class="n">pos_pks</span><span class="p">[</span><span class="n">good_ihr</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

                    <span class="c1"># If at least one peak is between HR limits:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_pks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Determines the location of the maximum peak:</span>
                        <span class="n">max_pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="n">pos_pks</span><span class="p">])</span>
                        <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_pk</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sig</span><span class="p">[</span><span class="n">pos_pks</span><span class="p">]))</span>
                        <span class="c1">#print(&#39;Second ROI: (1) Max Peak: &#39; + str(max_pk) + &#39;, amplitudes: &#39; + str(sig[pos_pks]) +</span>
                        <span class="c1">#  &#39;, index: &#39; + str(int(ind)), &#39;, pk_ind: &#39; + str(pos_pks[ind]))</span>
                        <span class="c1"># The maximum peak is added to the list:</span>
                        <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">pos_pks</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                        <span class="c1">#print(&#39;Locations: &#39; + str(locs))</span>
                <span class="c1"># If no peak was found:</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Counter for ROIs is reset to previous value:</span>
                    <span class="n">n_rois</span> <span class="o">=</span> <span class="n">n_rois</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="c1"># If it is the end of the any further ROI:</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If at least one peak has been found:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_pks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Measures instantantaneous HR of found peaks with respect to the previous peak:</span>
                    <span class="n">ihr</span> <span class="o">=</span> <span class="mi">60</span><span class="o">/</span><span class="p">((</span><span class="n">pos_pks</span> <span class="o">-</span> <span class="n">locs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">fs</span><span class="p">)</span>
                    <span class="n">good_ihr</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ihr</span> <span class="o">&lt;=</span> <span class="n">max_ihr</span> <span class="ow">and</span> <span class="n">ihr</span> <span class="o">&gt;=</span> <span class="n">min_ihr</span><span class="p">)</span>
                    <span class="c1">#print(&#39;Third ROI IHR check: (1) IHR: &#39; + str(ihr) + &#39;, valid peaks: &#39; + str(good_ihr) +</span>
                    <span class="c1">#      &#39;, pos_pks before: &#39; + str(pos_pks) + &#39;, pos_pks after: &#39; + str(pos_pks[good_ihr]))</span>
                    <span class="n">pos_pks</span> <span class="o">=</span> <span class="n">pos_pks</span><span class="p">[</span><span class="n">good_ihr</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

                    <span class="c1"># If at least one peak is between HR limits:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pos_pks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Calculates SDNN with the possible peaks on the ROI:</span>
                        <span class="n">sdnn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_pks</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos_pks</span><span class="p">)):</span>
                            <span class="n">sdnn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">locs</span><span class="o">/</span><span class="n">fs</span><span class="p">,</span> <span class="n">pos_pks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">fs</span><span class="p">))</span>
                        <span class="c1"># Determines the new peak as that one with the lowest SDNN:</span>
                        <span class="n">min_pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sdnn</span><span class="p">)</span>
                        <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">min_pk</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sdnn</span><span class="p">))</span>
                        <span class="c1">#print(&#39;Third ROI: (1) Min SDNN Peak: &#39; + str(min_pk) + &#39;, amplitudes: &#39; + str(sig[pos_pks]) +</span>
                        <span class="c1">#  &#39;, index: &#39; + str(int(ind)), &#39;, pk_ind: &#39; + str(pos_pks[ind]))</span>
                        <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">locs</span><span class="p">,</span> <span class="n">pos_pks</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                        <span class="c1">#print(&#39;Locations: &#39; + str(locs))</span>
                <span class="c1"># If no peak was found:</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Counter for ROIs is reset to previous value:</span>
                    <span class="n">n_rois</span> <span class="o">=</span> <span class="n">n_rois</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="c1"># Resets possible peaks for next ROI:</span>
            <span class="n">pos_pks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">locs</span> <span class="o">=</span> <span class="n">locs</span> <span class="o">-</span> <span class="n">len_ma</span>

    <span class="c1"># Correction of peaks</span>
    <span class="n">c_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">n_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">fs</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_int</span><span class="p">)):</span>
        <span class="n">ind1</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">locs</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
        <span class="c1">#print(&#39;Locs &gt;= &#39; + str((i)*w*fs) + &#39;: &#39; + str(locs[ind1]))</span>
        <span class="n">ind2</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">locs</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
        <span class="c1">#print(&#39;Locs &lt; &#39; + str((i + 1)*w*fs) + &#39;: &#39; + str(locs[ind2]))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">)</span>
        <span class="c1">#print(&#39;Larger and lower than locs: &#39; + str(locs[ind]))</span>
        <span class="n">int_locs</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aux_ibis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">int_locs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">locs</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">aux_ibis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">int_locs</span><span class="p">))</span>
        <span class="n">avg_ibis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">aux_ibis</span><span class="p">)</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">avg_ibis</span> <span class="o">-</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">avg_ibis</span><span class="p">),</span> <span class="p">(</span><span class="n">avg_ibis</span> <span class="o">+</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">avg_ibis</span><span class="p">))</span>
        <span class="n">ind1</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_ibis</span> <span class="o">&gt;</span> <span class="n">th</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">#print(&#39;Ind1: &#39; + str(ind1))</span>
        <span class="n">ind2</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_ibis</span> <span class="o">&lt;</span> <span class="n">th</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#print(&#39;Ind2: &#39; + str(ind2))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">)</span>
        <span class="c1">#print(&#39;Ind: &#39; + str(ind))</span>

        <span class="n">c_locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_locs</span><span class="p">,</span> <span class="n">int_locs</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">c_locs</span><span class="p">)</span>

    <span class="c1">#fig = plt.figure()</span>
    <span class="c1">#plt.plot(x)</span>
    <span class="c1">#plt.plot(sig)</span>
    <span class="c1">#plt.scatter(locs,x[locs],marker = &#39;o&#39;,color = &#39;red&#39;)</span>
    <span class="c1">#if len(c_locs) != 0:</span>
        <span class="c1">#plt.scatter(c_locs,x[c_locs],marker = &#39;o&#39;,color = &#39;blue&#39;)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_locs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ibis</span> <span class="o">=</span> <span class="n">c_locs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ibis</span> <span class="o">=</span> <span class="n">locs</span>

    <span class="k">return</span> <span class="n">ibis</span>

<span class="k">def</span> <span class="nf">d2max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detects inter-beat intervals using D2Max</span>
<span class="sd">    Citation: Elgendi M, Norton I, Brearley M, Abbott D, Schuurmans D (2013) Systolic Peak Detection in Acceleration</span>
<span class="sd">              Photoplethysmograms Measured from Emergency Responders in Tropical Conditions. PLoS ONE, vol. 8, no. 10,</span>
<span class="sd">              pp. e76585. DOI: 10.1371/journal.pone.0076585</span>

<span class="sd">    Inputs:   x, pulsatile signal [user defined units]</span>
<span class="sd">              fs, sampling rate [Hz]</span>
<span class="sd">    Outputs:  ibis, position of the starting points of inter-beat intervals [number of samples]</span>

<span class="sd">    Developed by:  Elisa Mejía Mejía</span>
<span class="sd">                   City, University of London</span>
<span class="sd">    Version:       1.0 -   June, 2022</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Bandpass filter</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4098</span><span class="p">:</span>
        <span class="n">z_fill</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4098</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">z_fill</span><span class="p">)</span>
    <span class="n">sos</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">btype</span> <span class="o">=</span> <span class="s1">&#39;bp&#39;</span><span class="p">,</span> <span class="n">analog</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;sos&#39;</span><span class="p">,</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">x_f</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sosfiltfilt</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="n">x_z</span><span class="p">)</span>

    <span class="c1"># Signal clipping</span>
    <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_f</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">x_c</span> <span class="o">=</span> <span class="n">x_f</span>
    <span class="n">x_c</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Signal squaring</span>
    <span class="n">x_s</span> <span class="o">=</span> <span class="n">x_c</span><span class="o">**</span><span class="mi">2</span>

    <span class="c1">#plt.figure()</span>
    <span class="c1">#plt.plot(x)</span>
    <span class="c1">#plt.plot(x_z)</span>
    <span class="c1">#plt.plot(x_f)</span>
    <span class="c1">#plt.plot(x_c)</span>
    <span class="c1">#plt.plot(x_s)</span>

    <span class="c1"># Blocks of interest</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">111e-3</span><span class="p">)</span><span class="o">*</span><span class="n">fs</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">w1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">w1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">w1</span><span class="p">)</span>
    <span class="n">ma_pk</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x_s</span><span class="p">)</span>

    <span class="n">w2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">667e-3</span><span class="p">)</span><span class="o">*</span><span class="n">fs</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">w2</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">w2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">w1</span><span class="p">)</span>
    <span class="n">ma_bpm</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x_s</span><span class="p">)</span>

    <span class="c1">#plt.figure()</span>
    <span class="c1">#plt.plot(x_s/np.max(x_s))</span>
    <span class="c1">#plt.plot(ma_pk/np.max(ma_pk))</span>
    <span class="c1">#plt.plot(ma_bpm/np.max(ma_bpm))</span>

    <span class="c1"># Thresholding</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.02</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ma_pk</span><span class="p">)</span>
    <span class="n">th_1</span> <span class="o">=</span> <span class="n">ma_bpm</span> <span class="o">+</span> <span class="n">alpha</span>
    <span class="n">th_2</span> <span class="o">=</span> <span class="n">w1</span>
    <span class="n">boi</span> <span class="o">=</span> <span class="p">(</span><span class="n">ma_pk</span> <span class="o">&gt;</span> <span class="n">th_1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">blocks_init</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">boi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">blocks_init</span> <span class="o">=</span> <span class="n">blocks_init</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">blocks_end</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">boi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">blocks_end</span> <span class="o">=</span> <span class="n">blocks_end</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">blocks_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">blocks_end</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">blocks_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">blocks_init</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">blocks_init</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">blocks_end</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">blocks_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blocks_end</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_s</span><span class="p">))</span>
    <span class="c1">#print(&#39;Initial locs BOI: &#39; + str(blocks_init))</span>
    <span class="c1">#print(&#39;Final locs BOI: &#39; + str(blocks_end))</span>

    <span class="c1">#plt.figure()</span>
    <span class="c1">#plt.plot(x_s[range(len(x))]/np.max(x_s))</span>
    <span class="c1">#plt.plot(boi[range(len(x))])</span>

    <span class="c1"># Search for peaks inside BOIs</span>
    <span class="n">len_blks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks_init</span><span class="p">))</span>
    <span class="n">ibis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks_init</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks_init</span><span class="p">)):</span>
        <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">blocks_end</span> <span class="o">&gt;</span> <span class="n">blocks_init</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">len_blks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">blocks_end</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">blocks_init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">len_blks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">th_2</span><span class="p">:</span>
            <span class="n">aux</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">blocks_init</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">blocks_end</span><span class="p">[</span><span class="n">ind</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span>
                <span class="n">max_ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">max_val</span> <span class="o">==</span> <span class="n">aux</span><span class="p">)</span>
                <span class="n">ibis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_ind</span> <span class="o">+</span> <span class="n">blocks_init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">len_blks</span> <span class="o">&lt;</span> <span class="n">th_2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)):</span>
            <span class="n">boi</span><span class="p">[</span><span class="n">blocks_init</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">blocks_end</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ind</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ibis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ibis</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ibis</span><span class="p">,</span> <span class="n">ind</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1">#plt.plot(boi[range(len(x))])</span>

    <span class="c1">#plt.figure()</span>
    <span class="c1">#plt.plot(x)</span>
    <span class="c1">#plt.scatter(ibis, x[ibis], marker = &#39;o&#39;,color = &#39;red&#39;)</span>

    <span class="k">return</span> <span class="n">ibis</span>

<span class="k">def</span> <span class="nf">upslopes</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detects inter-beat intervals using Upslopes</span>
<span class="sd">    Citation: Arguello Prada EJ, Serna Maldonado RD (2018) A novel and low-complexity peak detection algorithm for</span>
<span class="sd">              heart rate estimation from low-amplitude photoplethysmographic (PPG) signals. J Med Eng Technol, vol. 42,</span>
<span class="sd">              no. 8, pp. 569-577. DOI: 10.1080/03091902.2019.1572237</span>

<span class="sd">    Inputs:   x, pulsatile signal [user defined units]</span>
<span class="sd">    Outputs:  ibis, position of the starting points of inter-beat intervals [number of samples]</span>

<span class="sd">    Developed by:  Elisa Mejía Mejía</span>
<span class="sd">                   City, University of London</span>
<span class="sd">    Version:       1.0 -   June, 2022</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Peak detection</span>
    <span class="n">th</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">pks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pos_pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pos_pk_b</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_pos_pk</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_up</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">n_up</span> <span class="o">=</span> <span class="n">n_up</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n_up</span> <span class="o">&gt;</span> <span class="n">th</span><span class="p">:</span>
                <span class="n">pos_pk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_pk</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">pos_pk_b</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">n_pos_pk</span> <span class="o">=</span> <span class="n">n_pos_pk</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">n_up_pre</span> <span class="o">=</span> <span class="n">n_up</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos_pk</span> <span class="o">=</span> <span class="n">pos_pk</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="c1">#print(&#39;Possible peaks: &#39; + str(pos_pk) + &#39;, number of peaks: &#39; + str(n_pos_pk))</span>
                <span class="k">if</span> <span class="n">pos_pk_b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="n">pos_pk</span><span class="p">[</span><span class="n">n_pos_pk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]]:</span>
                        <span class="n">pos_pk</span><span class="p">[</span><span class="n">n_pos_pk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pks</span><span class="p">,</span> <span class="n">pos_pk</span><span class="p">[</span><span class="n">n_pos_pk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">th</span> <span class="o">=</span> <span class="mf">0.6</span><span class="o">*</span><span class="n">n_up_pre</span>
                    <span class="n">pos_pk_b</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n_up</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ibis</span> <span class="o">=</span> <span class="n">pks</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1">#print(ibis)</span>

    <span class="c1">#plt.figure()</span>
    <span class="c1">#plt.plot(x)</span>
    <span class="c1">#plt.scatter(ibis, x[ibis], marker = &#39;o&#39;,color = &#39;red&#39;)</span>

    <span class="k">return</span> <span class="n">ibis</span>

<span class="k">def</span> <span class="nf">delineator</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detects inter-beat intervals using Delineator</span>
<span class="sd">    Citation: Li BN, Dong MC, Vai MI (2010) On an automatic delineator for arterial blood pressure waveforms. Biomed</span>
<span class="sd">    Signal Process Control, vol. 5, no. 1, pp. 76-81. DOI: 10.1016/j.bspc.2009.06.002</span>

<span class="sd">    Inputs:   x, pulsatile signal [user defined units]</span>
<span class="sd">              fs, sampling rate [Hz]</span>
<span class="sd">    Outputs:  ibis, position of the starting points of inter-beat intervals [number of samples]</span>

<span class="sd">    Developed by:  Elisa Mejía Mejía</span>
<span class="sd">                   City, University of London</span>
<span class="sd">    Version:       1.0 -   June, 2022</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Lowpass filter</span>
    <span class="n">od</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">sos</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">od</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">btype</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="n">analog</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;sos&#39;</span><span class="p">,</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">fs</span><span class="p">)</span>
    <span class="n">x_f</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sosfiltfilt</span><span class="p">(</span><span class="n">sos</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">x_m</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">x_f</span>

    <span class="c1">#plt.figure()</span>
    <span class="c1">#plt.plot(x)</span>
    <span class="c1">#plt.plot(x_f)</span>
    <span class="c1">#plt.plot(x_m)</span>

    <span class="c1"># Moving average</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">x_ma</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">x_m</span><span class="p">)</span>

    <span class="c1"># Compute differentials</span>
    <span class="n">dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x_ma</span><span class="p">)</span>
    <span class="n">dif</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dif</span><span class="p">)</span>
    <span class="n">dif_ma</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">dif</span><span class="p">)</span>

    <span class="c1">#plt.figure()</span>
    <span class="c1">#plt.plot(x_ma)</span>
    <span class="c1">#plt.plot(dif_ma)</span>

    <span class="c1"># Average thresholds in original signal</span>
    <span class="n">x_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x_len</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="o">*</span><span class="n">fs</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">elif</span> <span class="n">x_len</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="o">*</span><span class="n">fs</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">elif</span> <span class="n">x_len</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="o">*</span><span class="n">fs</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">#print(n)</span>

    <span class="n">max_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1">#plt.figure()</span>
        <span class="c1">#plt.plot(x_ma)</span>
        <span class="n">n_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x_len</span><span class="o">/</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
        <span class="c1">#print(&#39;Length of intervals: &#39; + str(n_int))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="c1"># Searches for max and min in 1 s intervals</span>
            <span class="n">amp_min</span><span class="p">,</span> <span class="n">ind_min</span><span class="p">,</span> <span class="n">amp_max</span><span class="p">,</span> <span class="n">ind_max</span> <span class="o">=</span> <span class="n">seek_local</span><span class="p">(</span><span class="n">x_ma</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">n_int</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="o">*</span><span class="n">n_int</span> <span class="o">+</span> <span class="n">fs</span><span class="p">))</span>
            <span class="c1">#plt.scatter(ind_min, amp_min, marker = &#39;o&#39;, color = &#39;red&#39;)</span>
            <span class="c1">#plt.scatter(ind_max, amp_max, marker = &#39;o&#39;, color = &#39;green&#39;)</span>
            <span class="n">max_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_min</span><span class="p">,</span> <span class="p">(</span><span class="n">amp_max</span> <span class="o">-</span> <span class="n">amp_min</span><span class="p">))</span>
        <span class="n">max_min_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">max_min</span><span class="p">)</span>
        <span class="c1">#print(&#39;Local max and min: &#39; + str(max_min) + &#39;, average amplitude: &#39; + str(max_min_avg))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">amp_min</span><span class="p">,</span> <span class="n">ind_min</span> <span class="p">,</span> <span class="n">amp_max</span><span class="p">,</span> <span class="n">ind_max</span> <span class="o">=</span> <span class="n">seek_local</span><span class="p">(</span><span class="n">x_ma</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">close_win</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_len</span><span class="p">))</span>
        <span class="c1">#plt.figure()</span>
        <span class="c1">#plt.plot(x_ma)</span>
        <span class="c1">#plt.scatter(ind_min, amp_min, marker = &#39;o&#39;, color = &#39;red&#39;)</span>
        <span class="c1">#plt.scatter(ind_max, amp_max, marker = &#39;o&#39;, color = &#39;green&#39;)</span>
        <span class="n">max_min_avg</span> <span class="o">=</span> <span class="n">amp_max</span> <span class="o">-</span> <span class="n">amp_min</span>
        <span class="c1">#print(&#39;Local max and min: &#39; + str(max_min) + &#39;, average amplitude: &#39; + str(max_min_avg))</span>

    <span class="n">max_min_lt</span> <span class="o">=</span> <span class="mf">0.4</span><span class="o">*</span><span class="n">max_min_avg</span>

    <span class="c1"># Seek pulse beats by min-max method</span>
    <span class="n">step_win</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">fs</span>       <span class="c1"># Window length to look for peaks/onsets</span>
    <span class="n">close_win</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">fs</span><span class="p">)</span>
                          <span class="c1"># Value of what is considered too close</span>

    <span class="n">pks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>     <span class="c1"># Location of peaks</span>
    <span class="n">ons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>     <span class="c1"># Location of onsets</span>
    <span class="n">dic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>     <span class="c1"># Location of dicrotic notches</span>

    <span class="n">pk_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>          <span class="c1"># Number of peaks found</span>
    <span class="n">on_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>          <span class="c1"># Number of onsets found</span>
    <span class="n">dn_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>          <span class="c1"># Number of dicrotic notches found</span>

    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">close_win</span><span class="p">)</span>    <span class="c1"># Initializes counter</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">x_len</span><span class="p">:</span>      <span class="c1"># Iterates through the signal</span>
        <span class="c1">#print(&#39;i: &#39; + str(i))</span>
        <span class="n">amp_min</span> <span class="o">=</span> <span class="n">x_ma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># Gets the initial value for the minimum amplitude</span>
        <span class="n">amp_max</span> <span class="o">=</span> <span class="n">x_ma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># Gets the initial value for the maximum amplitude</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="n">i</span>           <span class="c1"># Initializes the temporal location of the index</span>
        <span class="n">aux_pks</span> <span class="o">=</span> <span class="n">i</span>       <span class="c1"># Initializes the temporal location of the peak</span>
        <span class="n">aux_ons</span> <span class="o">=</span> <span class="n">i</span>       <span class="c1"># Initializes the temporal location of the onset</span>

        <span class="c1"># Iterates while ind is lower than the length of the signal</span>
        <span class="k">while</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="n">x_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">#print(&#39;Ind: &#39; + str(ind))</span>
            <span class="c1"># Verifies if no peak has been found in 2 seconds</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ind</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">step_win</span><span class="p">:</span>
                <span class="c1">#print(&#39;Peak not found in 2 s&#39;)</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">i</span>   <span class="c1"># Refreshes the temporal location of the index</span>
                <span class="n">max_min_avg</span> <span class="o">=</span> <span class="mf">0.6</span><span class="o">*</span><span class="n">max_min_avg</span>  <span class="c1"># Refreshes the threshold for the amplitude</span>
                <span class="c1"># Verifies if the threshold is lower than the lower limit</span>
                <span class="k">if</span> <span class="n">max_min_avg</span> <span class="o">&lt;=</span> <span class="n">max_min_lt</span><span class="p">:</span>
                    <span class="n">max_min_avg</span> <span class="o">=</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">max_min_lt</span> <span class="c1"># Refreshes the threshold</span>
                <span class="k">break</span>

            <span class="c1"># Verifies if the location is a candidate peak</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dif_ma</span><span class="p">[</span><span class="n">ind</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dif_ma</span><span class="p">[</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1">#print(&#39;There is a candidate peak&#39;)</span>
                <span class="c1"># Determines initial and end points of a window to search for local peaks and onsets</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">x_len</span><span class="p">:</span>
                    <span class="n">i_stop</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i_stop</span> <span class="o">=</span> <span class="n">x_len</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ind</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i_start</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">-</span> <span class="mi">5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i_start</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Checks for artifacts of saturated or signal loss</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i_stop</span> <span class="o">-</span> <span class="n">ind</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">i_stop</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">dif_ma</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i_stop</span><span class="p">:</span>
                        <span class="c1">#print(&#39;Artifact&#39;)</span>
                        <span class="k">break</span>

                <span class="c1"># Candidate onset</span>
                <span class="c1">#print(&#39;Looking for candidate onsets...&#39;)</span>
                <span class="c1">#plt.figure()</span>
                <span class="c1">#plt.plot(x_ma)</span>
                <span class="k">if</span> <span class="n">dif_ma</span><span class="p">[</span><span class="n">i_start</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dif_ma</span><span class="p">[</span><span class="n">i_stop</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">aux_min</span><span class="p">,</span> <span class="n">ind_min</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">seek_local</span><span class="p">(</span><span class="n">x_ma</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_start</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_stop</span><span class="p">))</span>
                        <span class="c1">#plt.scatter(ind_min, aux_min, marker = &#39;o&#39;, color = &#39;red&#39;)</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ind_min</span> <span class="o">-</span> <span class="n">ind</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">amp_min</span> <span class="o">=</span> <span class="n">aux_min</span>
                            <span class="n">aux_ons</span> <span class="o">=</span> <span class="n">ind_min</span>
                <span class="c1">#print(&#39;Candidate onset: &#39; + str([ind_min, amp_min]))</span>
                <span class="c1"># Candidate peak</span>
                <span class="c1">#print(&#39;Looking for candidate peaks...&#39;)</span>
                <span class="k">if</span> <span class="n">dif_ma</span><span class="p">[</span><span class="n">i_start</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dif_ma</span><span class="p">[</span><span class="n">i_stop</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">aux_max</span><span class="p">,</span> <span class="n">ind_max</span> <span class="o">=</span> <span class="n">seek_local</span><span class="p">(</span><span class="n">x_ma</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_start</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_stop</span><span class="p">))</span>
                        <span class="c1">#plt.scatter(ind_max, aux_max, marker = &#39;o&#39;, color = &#39;green&#39;)</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ind_max</span> <span class="o">-</span> <span class="n">ind</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">amp_max</span> <span class="o">=</span> <span class="n">aux_max</span>
                            <span class="n">aux_pks</span> <span class="o">=</span> <span class="n">ind_max</span>
                <span class="c1">#print(&#39;Candidate peak: &#39; + str([ind_max, amp_max]))</span>
                <span class="c1"># Verifies if the amplitude of the pulse is larger than 0.4 times the mean value:</span>
                <span class="c1">#print(&#39;Pulse amplitude: &#39; + str(amp_max - amp_min) + &#39;, thresholds: &#39; +</span>
                <span class="c1">#      str([0.4*max_min_avg, 2*max_min_avg]))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">amp_max</span> <span class="o">-</span> <span class="n">amp_min</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="o">*</span><span class="n">max_min_avg</span><span class="p">:</span>
                    <span class="c1">#print(&#39;Expected amplitude of pulse&#39;)</span>
                    <span class="c1"># Verifies if the amplitude of the pulse is lower than 2 times the mean value:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">amp_max</span> <span class="o">-</span> <span class="n">amp_min</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">max_min_avg</span><span class="p">:</span>
                        <span class="c1">#print(&#39;Expected duration of pulse&#39;)</span>
                        <span class="k">if</span> <span class="n">aux_pks</span> <span class="o">&gt;</span> <span class="n">aux_ons</span><span class="p">:</span>
                            <span class="c1">#print(&#39;Refining onsets...&#39;)</span>
                            <span class="c1"># Refine onsets:</span>
                            <span class="n">aux_min</span> <span class="o">=</span> <span class="n">x_ma</span><span class="p">[</span><span class="n">aux_ons</span><span class="p">]</span>
                            <span class="n">temp_ons</span> <span class="o">=</span> <span class="n">aux_ons</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aux_pks</span><span class="p">,</span> <span class="n">aux_ons</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">x_ma</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">aux_min</span><span class="p">:</span>
                                    <span class="n">aux_min</span> <span class="o">=</span> <span class="n">x_ma</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                                    <span class="n">temp_ons</span> <span class="o">=</span> <span class="n">j</span>
                            <span class="n">amp_min</span> <span class="o">=</span> <span class="n">aux_min</span>
                            <span class="n">aux_ons</span> <span class="o">=</span> <span class="n">temp_ons</span>

                            <span class="c1"># If there is at least one peak found before:</span>
                            <span class="c1">#print(&#39;Number of previous peaks: &#39; + str(pk_index + 1))</span>
                            <span class="k">if</span> <span class="n">pk_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c1">#print(&#39;There were previous peaks&#39;)</span>
                                <span class="c1">#print(&#39;Duration of ons to peak interval: &#39; + str(aux_ons - pks[pk_index]) +</span>
                                <span class="c1">#     &#39;, threshold: &#39; + str([3*close_win, step_win]))</span>
                                <span class="c1"># If the duration of the pulse is too short:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">aux_ons</span> <span class="o">-</span> <span class="n">pks</span><span class="p">[</span><span class="n">pk_index</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">*</span><span class="n">close_win</span><span class="p">:</span>
                                    <span class="c1">#print(&#39;Too short interbeat interval&#39;)</span>
                                    <span class="n">ind</span> <span class="o">=</span> <span class="n">i</span>
                                    <span class="n">max_min_avg</span> <span class="o">=</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">max_min_lt</span>
                                    <span class="k">break</span>
                                <span class="c1"># If the time difference between consecutive peaks is longer:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">aux_pks</span> <span class="o">-</span> <span class="n">pks</span><span class="p">[</span><span class="n">pk_index</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">step_win</span><span class="p">:</span>
                                    <span class="c1">#print(&#39;Too long interbeat interval&#39;)</span>
                                    <span class="n">pk_index</span> <span class="o">=</span> <span class="n">pk_index</span> <span class="o">-</span> <span class="mi">1</span>
                                    <span class="n">on_index</span> <span class="o">=</span> <span class="n">on_index</span> <span class="o">-</span> <span class="mi">1</span>
                                    <span class="c1">#if dn_index &gt; 0:</span>
                                    <span class="c1">#    dn_index = dn_index - 1</span>
                                <span class="c1"># If there are still peaks, add the new peak:</span>
                                <span class="k">if</span> <span class="n">pk_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="c1">#print(&#39;There are still previous peaks&#39;)</span>
                                    <span class="n">pk_index</span> <span class="o">=</span> <span class="n">pk_index</span> <span class="o">+</span> <span class="mi">1</span>
                                    <span class="n">on_index</span> <span class="o">=</span> <span class="n">on_index</span> <span class="o">+</span> <span class="mi">1</span>
                                    <span class="n">pks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pks</span><span class="p">,</span> <span class="n">aux_pks</span><span class="p">)</span>
                                    <span class="n">ons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ons</span><span class="p">,</span> <span class="n">aux_ons</span><span class="p">)</span>
                                    <span class="c1">#print(&#39;Peaks: &#39; + str(pks))</span>
                                    <span class="c1">#print(&#39;Onsets: &#39; + str(ons))</span>

                                    <span class="n">tf</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[</span><span class="n">pk_index</span><span class="p">]</span> <span class="o">-</span> <span class="n">ons</span><span class="p">[</span><span class="n">pk_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

                                    <span class="n">to</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">fs</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span>
                                    <span class="n">tff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">tf</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">tff</span> <span class="o">&lt;</span> <span class="n">to</span><span class="p">:</span>
                                        <span class="n">to</span> <span class="o">=</span> <span class="n">tff</span>
                                    <span class="n">to</span> <span class="o">=</span> <span class="n">pks</span><span class="p">[</span><span class="n">pk_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">to</span>

                                    <span class="n">te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">fs</span><span class="o">/</span><span class="mi">20</span><span class="p">)</span>
                                    <span class="n">tff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">tf</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">tff</span> <span class="o">&lt;</span> <span class="n">te</span><span class="p">:</span>
                                        <span class="n">te</span> <span class="o">=</span> <span class="n">tff</span>
                                    <span class="n">te</span> <span class="o">=</span> <span class="n">pks</span><span class="p">[</span><span class="n">pk_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">te</span>

                                    <span class="c1">#tff = seek_dicrotic(dif_ma[to:te])</span>
                                    <span class="c1">#if tff == 0:</span>
                                    <span class="c1">#    tff = te - pks[pk_index - 1]</span>
                                    <span class="c1">#    tff = np.floor(tff/3)</span>
                                    <span class="c1">#dn_index = dn_index + 1</span>
                                    <span class="c1">#dic[dn_index] = to + tff</span>

                                    <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">+</span> <span class="n">close_win</span>
                                    <span class="k">break</span>
                            <span class="c1"># If it is the first peak:</span>
                            <span class="k">if</span> <span class="n">pk_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="c1">#print(&#39;There were no previous peaks&#39;)</span>
                                <span class="n">pk_index</span> <span class="o">=</span> <span class="n">pk_index</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="n">on_index</span> <span class="o">=</span> <span class="n">on_index</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="n">pks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pks</span><span class="p">,</span> <span class="n">aux_pks</span><span class="p">)</span>
                                <span class="n">ons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ons</span><span class="p">,</span> <span class="n">aux_ons</span><span class="p">)</span>
                                <span class="c1">#print(&#39;Peaks: &#39; + str(pks))</span>
                                <span class="c1">#print(&#39;Onsets: &#39; + str(ons))</span>
                                <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">+</span> <span class="n">close_win</span>
                                <span class="k">break</span>

            <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pks</span><span class="p">)</span>
        <span class="n">temp_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_len</span><span class="p">):</span>
            <span class="n">temp_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_p</span><span class="p">,</span> <span class="n">pks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">od</span><span class="p">)</span>
        <span class="n">ttk</span> <span class="o">=</span> <span class="n">temp_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ttk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">temp_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="n">temp_p</span>

        <span class="n">x_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ons</span><span class="p">)</span>
        <span class="n">temp_o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_len</span><span class="p">):</span>
            <span class="n">temp_o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_o</span><span class="p">,</span> <span class="n">ons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">od</span><span class="p">)</span>
        <span class="n">ttk</span> <span class="o">=</span> <span class="n">temp_o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ttk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">temp_o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ons</span> <span class="o">=</span> <span class="n">temp_o</span>

    <span class="n">pks</span> <span class="o">=</span> <span class="n">pks</span> <span class="o">+</span> <span class="mi">5</span>
    <span class="n">ibis</span> <span class="o">=</span> <span class="n">pks</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ibis</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<hr class="docutils" />
<section id="fiducial-point-functions">
<h2>Fiducial Point functions<a class="headerlink" href="#fiducial-point-functions" title="Link to this heading">#</a></h2>
<p>The following functions are required to detect fiducial points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fiducial_points</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pks</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="n">vis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Description: Pulse detection and correction from pulsatile signals</span>
<span class="sd">    Inputs:  x, array with pulsatile signal [user defined units]</span>
<span class="sd">             pks, array with the position of the peaks [number of samples]</span>
<span class="sd">             fs, sampling rate of signal [Hz]</span>
<span class="sd">             vis, visualisation option [True, False]</span>
<span class="sd">    Outputs: fidp, dictionary with the positions of several fiducial points for the cardiac cycles [number of samples]</span>

<span class="sd">    Fiducial points:  1: Systolic peak (pks)</span>
<span class="sd">                      2: Onset, as the minimum before the systolic peak (ons)</span>
<span class="sd">                      3: Onset, using the tangent intersection method (ti)</span>
<span class="sd">                      4: Diastolic peak (dpk)</span>
<span class="sd">                      5: Maximum slope (m1d)</span>
<span class="sd">                      6: a point from second derivative PPG (a2d)</span>
<span class="sd">                      7: b point from second derivative PPG (b2d)</span>
<span class="sd">                      8: c point from second derivative PPG (c2d)</span>
<span class="sd">                      9: d point from second derivative PPG (d2d)</span>
<span class="sd">                      10: e point from second derivative PPG (e2d)</span>
<span class="sd">                      11: p1 from the third derivative PPG (p1)</span>
<span class="sd">                      12: p2 from the third derivative PPG (p2)</span>

<span class="sd">    Libraries: NumPy (as np), SciPy (Signal, as sp), Matplotlib (PyPlot, as plt)</span>

<span class="sd">    Version: 1.0 - June 2022</span>

<span class="sd">    Developed by: Elisa Mejía-Mejía</span>
<span class="sd">                   City, University of London</span>

<span class="sd">    Edited by: Peter Charlton (see &quot;Added by PC&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># First, second and third derivatives</span>
    <span class="n">d1x</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">deriv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">d2x</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">deriv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">d3x</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">deriv</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1">#plt.figure()</span>
    <span class="c1">#plt.plot(x/np.max(x))</span>
    <span class="c1">#plt.plot(d1x/np.max(d1x))</span>
    <span class="c1">#plt.plot(d2x/np.max(d2x))</span>
    <span class="c1">#plt.plot(d3x/np.max(d3x))</span>

    <span class="c1"># Search in time series: Onsets between consecutive peaks</span>
    <span class="n">ons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pks</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">pks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">pks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ibi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="c1">#plt.figure()</span>
        <span class="c1">#plt.plot(ibi, color = &#39;black&#39;)</span>
        <span class="n">aux_ons</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ibi</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ibi</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux_ons</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">aux_ons</span> <span class="o">=</span> <span class="n">aux_ons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ind_ons</span> <span class="o">=</span> <span class="n">aux_ons</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ons</span><span class="p">,</span> <span class="n">ind_ons</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span>
        <span class="c1">#plt.plot(ind_ons, ibi[ind_ons], marker = &#39;o&#39;, color = &#39;red&#39;)</span>
    <span class="n">ons</span> <span class="o">=</span> <span class="n">ons</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1">#print(&#39;Onsets: &#39; + str(ons))</span>
    <span class="c1">#plt.figure()</span>
    <span class="c1">#plt.plot(x, color = &#39;black&#39;)</span>
    <span class="c1">#plt.scatter(pks, x[pks], marker = &#39;o&#39;, color = &#39;red&#39;)</span>
    <span class="c1">#plt.scatter(ons, x[ons], marker = &#39;o&#39;, color = &#39;blue&#39;)</span>

    <span class="c1"># Search in time series: Diastolic peak and dicrotic notch between consecutive onsets</span>
    <span class="n">dia</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ons</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ind_pks</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pks</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pks</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">))</span>
        <span class="n">ind_pks</span> <span class="o">=</span> <span class="n">pks</span><span class="p">[</span><span class="n">ind_pks</span><span class="p">]</span>
        <span class="n">ibi_portion</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">ind_pks</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">ibi_2d_portion</span> <span class="o">=</span> <span class="n">d2x</span><span class="p">[</span><span class="n">ind_pks</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="c1">#plt.figure()</span>
        <span class="c1">#plt.plot(ibi_portion/np.max(ibi_portion))</span>
        <span class="c1">#plt.plot(ibi_2d_portion/np.max(ibi_2d_portion))</span>
        <span class="n">aux_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">)</span>
        <span class="n">aux_dic</span> <span class="o">=</span> <span class="n">aux_dic</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">aux_dia</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="o">-</span><span class="n">ibi_2d_portion</span><span class="p">)</span>
        <span class="n">aux_dia</span> <span class="o">=</span> <span class="n">aux_dia</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux_dic</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ind_max</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">[</span><span class="n">aux_dic</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">[</span><span class="n">aux_dic</span><span class="p">]))</span>
            <span class="n">aux_dic_max</span> <span class="o">=</span> <span class="n">aux_dic</span><span class="p">[</span><span class="n">ind_max</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux_dia</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nearest</span> <span class="o">=</span> <span class="n">aux_dia</span> <span class="o">-</span> <span class="n">aux_dic_max</span>
                <span class="n">aux_dic</span> <span class="o">=</span> <span class="n">aux_dic_max</span>
                <span class="n">dic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="p">(</span><span class="n">aux_dic</span> <span class="o">+</span> <span class="n">ind_pks</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                <span class="c1">#plt.scatter(aux_dic, ibi_portion[aux_dic]/np.max(ibi_portion), marker = &#39;o&#39;)</span>
                <span class="n">ind_dia</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nearest</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">aux_dia</span> <span class="o">=</span> <span class="n">aux_dia</span><span class="p">[</span><span class="n">ind_dia</span><span class="p">]</span>
                <span class="n">nearest</span> <span class="o">=</span> <span class="n">nearest</span><span class="p">[</span><span class="n">ind_dia</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nearest</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ind_nearest</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nearest</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nearest</span><span class="p">))</span>
                    <span class="n">aux_dia</span> <span class="o">=</span> <span class="n">aux_dia</span><span class="p">[</span><span class="n">ind_nearest</span><span class="p">]</span>
                    <span class="n">dia</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dia</span><span class="p">,</span> <span class="p">(</span><span class="n">aux_dia</span> <span class="o">+</span> <span class="n">ind_pks</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                    <span class="c1">#plt.scatter(aux_dia, ibi_portion[aux_dia]/np.max(ibi_portion), marker = &#39;o&#39;)</span>
                    <span class="c1">#break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="p">(</span><span class="n">aux_dic_max</span> <span class="o">+</span> <span class="n">ind_pks</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
                <span class="c1">#plt.scatter(aux_dia, ibi_portion[aux_dia]/np.max(ibi_portion), marker = &#39;o&#39;)</span>
    <span class="n">dia</span> <span class="o">=</span> <span class="n">dia</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">dic</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1">#plt.scatter(dia, x[dia], marker = &#39;o&#39;, color = &#39;orange&#39;)</span>
    <span class="c1">#plt.scatter(dic, x[dic], marker = &#39;o&#39;, color = &#39;green&#39;)</span>

    <span class="c1"># Search in D1: Maximum slope point</span>
    <span class="n">m1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ons</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ind_pks</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pks</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pks</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">))</span>
        <span class="n">ind_pks</span> <span class="o">=</span> <span class="n">pks</span><span class="p">[</span><span class="n">ind_pks</span><span class="p">]</span>
        <span class="n">ibi_portion</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">ind_pks</span><span class="p">]</span>
        <span class="n">ibi_1d_portion</span> <span class="o">=</span> <span class="n">d1x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">ind_pks</span><span class="p">]</span>
        <span class="c1">#plt.figure()</span>
        <span class="c1">#plt.plot(ibi_portion/np.max(ibi_portion))</span>
        <span class="c1">#plt.plot(ibi_1d_portion/np.max(ibi_1d_portion))</span>
        <span class="n">aux_m1d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">ibi_1d_portion</span><span class="p">)</span>
        <span class="n">aux_m1d</span> <span class="o">=</span> <span class="n">aux_m1d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux_m1d</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ind_max</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ibi_1d_portion</span><span class="p">[</span><span class="n">aux_m1d</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ibi_1d_portion</span><span class="p">[</span><span class="n">aux_m1d</span><span class="p">]))</span>
            <span class="n">aux_m1d_max</span> <span class="o">=</span> <span class="n">aux_m1d</span><span class="p">[</span><span class="n">ind_max</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux_m1d_max</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">aux_m1d_max</span> <span class="o">=</span> <span class="n">aux_m1d_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">m1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m1d</span><span class="p">,</span> <span class="p">(</span><span class="n">aux_m1d_max</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
            <span class="c1">#plt.scatter(aux_m1d, ibi_portion[aux_dic]/np.max(ibi_portion), marker = &#39;o&#39;)</span>
            <span class="c1">#break</span>
    <span class="n">m1d</span> <span class="o">=</span> <span class="n">m1d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1">#plt.scatter(m1d, x[m1d], marker = &#39;o&#39;, color = &#39;purple&#39;)</span>

    <span class="c1"># Search in time series: Tangent intersection points</span>
    <span class="n">tip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ons</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ibi_portion</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">ibi_1d_portion</span> <span class="o">=</span> <span class="n">d1x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">ind_m1d</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m1d</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m1d</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">))</span>
        <span class="n">ind_m1d</span> <span class="o">=</span> <span class="n">m1d</span><span class="p">[</span><span class="n">ind_m1d</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span>
        <span class="c1">#plt.figure()</span>
        <span class="c1">#plt.plot(ibi_portion/np.max(ibi_portion))</span>
        <span class="c1">#plt.plot(ibi_1d_portion/np.max(ibi_1d_portion))</span>
        <span class="c1">#plt.scatter(ind_m1d, ibi_portion[ind_m1d]/np.max(ibi_portion), marker = &#39;o&#39;)</span>
        <span class="c1">#plt.scatter(ind_m1d, ibi_1d_portion[ind_m1d]/np.max(ibi_1d_portion), marker = &#39;o&#39;)</span>
        <span class="n">aux_tip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(((</span><span class="n">ibi_portion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ibi_portion</span><span class="p">[</span><span class="n">ind_m1d</span><span class="p">])</span><span class="o">/</span><span class="n">ibi_1d_portion</span><span class="p">[</span><span class="n">ind_m1d</span><span class="p">])</span> <span class="o">+</span> <span class="n">ind_m1d</span><span class="p">)</span>
        <span class="n">aux_tip</span> <span class="o">=</span> <span class="n">aux_tip</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">tip</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tip</span><span class="p">,</span> <span class="p">(</span><span class="n">aux_tip</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="c1">#plt.scatter(aux_tip, ibi_portion[aux_tip]/np.max(ibi_portion), marker = &#39;o&#39;)</span>
        <span class="c1">#break</span>
    <span class="n">tip</span> <span class="o">=</span> <span class="n">tip</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1">#plt.scatter(tip, x[tip], marker = &#39;o&#39;, color = &#39;aqua&#39;)</span>

    <span class="c1"># Search in D2: A, B, C, D and E points</span>
    <span class="n">a2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">b2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">c2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">d2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">e2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ons</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ibi_portion</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">ibi_1d_portion</span> <span class="o">=</span> <span class="n">d1x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">ibi_2d_portion</span> <span class="o">=</span> <span class="n">d2x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">ind_m1d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m1d</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m1d</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">))</span>
        <span class="n">ind_m1d</span> <span class="o">=</span> <span class="n">m1d</span><span class="p">[</span><span class="n">ind_m1d</span><span class="p">]</span>
        <span class="c1">#plt.figure()</span>
        <span class="c1">#plt.plot(ibi_portion/np.max(ibi_portion))</span>
        <span class="c1">#plt.plot(ibi_1d_portion/np.max(ibi_1d_portion))</span>
        <span class="c1">#plt.plot(ibi_2d_portion/np.max(ibi_2d_portion))</span>
        <span class="n">aux_m2d_pks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">)</span>
        <span class="n">aux_m2d_ons</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="o">-</span><span class="n">ibi_2d_portion</span><span class="p">)</span>
        <span class="c1"># a point:</span>
        <span class="n">ind_a</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">[</span><span class="n">aux_m2d_pks</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">[</span><span class="n">aux_m2d_pks</span><span class="p">]))</span>
        <span class="n">ind_a</span> <span class="o">=</span> <span class="n">aux_m2d_pks</span><span class="p">[</span><span class="n">ind_a</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ind_a</span> <span class="o">&lt;</span> <span class="n">ind_m1d</span><span class="p">):</span>
            <span class="n">a2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a2d</span><span class="p">,</span> <span class="n">ind_a</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span>
            <span class="c1">#plt.scatter(ind_a, ibi_2d_portion[ind_a]/np.max(ibi_2d_portion), marker = &#39;o&#39;)</span>
            <span class="c1"># b point:</span>
            <span class="n">ind_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">[</span><span class="n">aux_m2d_ons</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">[</span><span class="n">aux_m2d_ons</span><span class="p">]))</span>
            <span class="n">ind_b</span> <span class="o">=</span> <span class="n">aux_m2d_ons</span><span class="p">[</span><span class="n">ind_b</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ind_b</span> <span class="o">&gt;</span> <span class="n">ind_a</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ind_b</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">)):</span>
                <span class="n">b2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b2d</span><span class="p">,</span> <span class="n">ind_b</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span>
                <span class="c1">#plt.scatter(ind_b, ibi_2d_portion[ind_b]/np.max(ibi_2d_portion), marker = &#39;o&#39;)</span>
        <span class="c1"># e point:</span>
        <span class="n">ind_e</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_m2d_pks</span> <span class="o">&gt;</span> <span class="n">ind_m1d</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        <span class="n">aux_m2d_pks</span> <span class="o">=</span> <span class="n">aux_m2d_pks</span><span class="p">[</span><span class="n">ind_e</span><span class="p">]</span>
        <span class="n">ind_e</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_m2d_pks</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">))</span>
        <span class="n">ind_e</span> <span class="o">=</span> <span class="n">aux_m2d_pks</span><span class="p">[</span><span class="n">ind_e</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_e</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_e</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ind_e</span> <span class="o">=</span> <span class="n">ind_e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">e2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e2d</span><span class="p">,</span> <span class="n">ind_e</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span>
            <span class="c1">#plt.scatter(ind_e, ibi_2d_portion[ind_e]/np.max(ibi_2d_portion), marker = &#39;o&#39;)</span>
            <span class="c1"># c point:</span>
            <span class="n">ind_c</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_m2d_pks</span> <span class="o">&lt;</span> <span class="n">ind_e</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ind_c_aux</span> <span class="o">=</span> <span class="n">aux_m2d_pks</span><span class="p">[</span><span class="n">ind_c</span><span class="p">]</span>
                <span class="n">ind_c</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">[</span><span class="n">ind_c_aux</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">[</span><span class="n">ind_c_aux</span><span class="p">]))</span>
                <span class="n">ind_c</span> <span class="o">=</span> <span class="n">ind_c_aux</span><span class="p">[</span><span class="n">ind_c</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">c2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2d</span><span class="p">,</span> <span class="n">ind_c</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span>
                    <span class="c1">#plt.scatter(ind_c, ibi_2d_portion[ind_c]/np.max(ibi_2d_portion), marker = &#39;o&#39;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aux_m1d_ons</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="o">-</span><span class="n">ibi_1d_portion</span><span class="p">)</span>
                <span class="n">ind_c</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_m1d_ons</span> <span class="o">&lt;</span> <span class="n">ind_e</span><span class="p">)</span>
                <span class="n">ind_c_aux</span> <span class="o">=</span> <span class="n">aux_m1d_ons</span><span class="p">[</span><span class="n">ind_c</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ind_c</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ind_c_aux</span> <span class="o">&gt;</span> <span class="n">ind_b</span><span class="p">)</span>
                    <span class="n">ind_c</span> <span class="o">=</span> <span class="n">ind_c_aux</span><span class="p">[</span><span class="n">ind_c</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">ind_c</span> <span class="o">=</span> <span class="n">ind_c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">c2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2d</span><span class="p">,</span> <span class="n">ind_c</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span>
                    <span class="c1">#plt.scatter(ind_c, ibi_2d_portion[ind_c]/np.max(ibi_2d_portion), marker = &#39;o&#39;)</span>
            <span class="c1"># d point:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ind_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_m2d_ons</span> <span class="o">&lt;</span> <span class="n">ind_e</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_m2d_ons</span> <span class="o">&gt;</span> <span class="n">ind_c</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_d</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ind_d_aux</span> <span class="o">=</span> <span class="n">aux_m2d_ons</span><span class="p">[</span><span class="n">ind_d</span><span class="p">]</span>
                    <span class="n">ind_d</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">[</span><span class="n">ind_d_aux</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ibi_2d_portion</span><span class="p">[</span><span class="n">ind_d_aux</span><span class="p">]))</span>
                    <span class="n">ind_d</span> <span class="o">=</span> <span class="n">ind_d_aux</span><span class="p">[</span><span class="n">ind_d</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_d</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">d2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d2d</span><span class="p">,</span> <span class="n">ind_d</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span>
                        <span class="c1">#plt.scatter(ind_d, ibi_2d_portion[ind_d]/np.max(ibi_2d_portion), marker = &#39;o&#39;)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ind_d</span> <span class="o">=</span> <span class="n">ind_c</span>
                    <span class="n">d2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d2d</span><span class="p">,</span> <span class="n">ind_d</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span>
                    <span class="c1">#plt.scatter(ind_d, ibi_2d_portion[ind_d]/np.max(ibi_2d_portion), marker = &#39;o&#39;)</span>
    <span class="n">a2d</span> <span class="o">=</span> <span class="n">a2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">b2d</span> <span class="o">=</span> <span class="n">b2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">c2d</span> <span class="o">=</span> <span class="n">c2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">d2d</span> <span class="o">=</span> <span class="n">d2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">e2d</span> <span class="o">=</span> <span class="n">e2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1">#plt.figure()</span>
    <span class="c1">#plt.plot(d2x, color = &#39;black&#39;)</span>
    <span class="c1">#plt.scatter(a2d, d2x[a2d], marker = &#39;o&#39;, color = &#39;red&#39;)</span>
    <span class="c1">#plt.scatter(b2d, d2x[b2d], marker = &#39;o&#39;, color = &#39;blue&#39;)</span>
    <span class="c1">#plt.scatter(c2d, d2x[c2d], marker = &#39;o&#39;, color = &#39;green&#39;)</span>
    <span class="c1">#plt.scatter(d2d, d2x[d2d], marker = &#39;o&#39;, color = &#39;orange&#39;)</span>
    <span class="c1">#plt.scatter(e2d, d2x[e2d], marker = &#39;o&#39;, color = &#39;purple&#39;)</span>

    <span class="c1"># Search in D3: P1 and P2 points</span>
    <span class="n">p1p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">p2p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ons</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ibi_portion</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">ibi_1d_portion</span> <span class="o">=</span> <span class="n">d1x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">ibi_2d_portion</span> <span class="o">=</span> <span class="n">d2x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">ibi_3d_portion</span> <span class="o">=</span> <span class="n">d3x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>
        <span class="n">ind_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">b2d</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">b2d</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">))</span>
        <span class="n">ind_b</span> <span class="o">=</span> <span class="n">b2d</span><span class="p">[</span><span class="n">ind_b</span><span class="p">]</span>
        <span class="n">ind_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c2d</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c2d</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">))</span>
        <span class="n">ind_c</span> <span class="o">=</span> <span class="n">c2d</span><span class="p">[</span><span class="n">ind_c</span><span class="p">]</span>
        <span class="n">ind_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d2d</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d2d</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">))</span>
        <span class="n">ind_d</span> <span class="o">=</span> <span class="n">d2d</span><span class="p">[</span><span class="n">ind_d</span><span class="p">]</span>
        <span class="n">ind_dic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dic</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dic</span> <span class="o">&lt;</span> <span class="n">stop</span><span class="p">))</span>
        <span class="n">ind_dic</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="n">ind_dic</span><span class="p">]</span>
        <span class="c1">#plt.figure()</span>
        <span class="c1">#plt.plot(ibi_portion/np.max(ibi_portion))</span>
        <span class="c1">#plt.plot(ibi_1d_portion/np.max(ibi_1d_portion))</span>
        <span class="c1">#plt.plot(ibi_2d_portion/np.max(ibi_2d_portion))</span>
        <span class="c1">#plt.plot(ibi_3d_portion/np.max(ibi_3d_portion))</span>
        <span class="c1">#plt.scatter(ind_b - start, ibi_3d_portion[ind_b - start]/np.max(ibi_3d_portion), marker = &#39;o&#39;)</span>
        <span class="c1">#plt.scatter(ind_c - start, ibi_3d_portion[ind_c - start]/np.max(ibi_3d_portion), marker = &#39;o&#39;)</span>
        <span class="c1">#plt.scatter(ind_d - start, ibi_3d_portion[ind_d - start]/np.max(ibi_3d_portion), marker = &#39;o&#39;)</span>
        <span class="c1">#plt.scatter(ind_dic - start, ibi_3d_portion[ind_dic - start]/np.max(ibi_3d_portion), marker = &#39;o&#39;)</span>
        <span class="n">aux_p3d_pks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">ibi_3d_portion</span><span class="p">)</span>
        <span class="n">aux_p3d_ons</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="o">-</span><span class="n">ibi_3d_portion</span><span class="p">)</span>
        <span class="c1"># P1:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aux_p3d_pks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">ind_p1</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_p3d_pks</span> <span class="o">&gt;</span> <span class="n">ind_b</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_p1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ind_p1</span> <span class="o">=</span> <span class="n">aux_p3d_pks</span><span class="p">[</span><span class="n">ind_p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">p1p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1p</span><span class="p">,</span> <span class="n">ind_p1</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span>
                <span class="c1">#plt.scatter(ind_p1, ibi_3d_portion[ind_p1]/np.max(ibi_3d_portion), marker = &#39;o&#39;)</span>
        <span class="c1"># P2:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aux_p3d_ons</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_d</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ind_c</span> <span class="o">==</span> <span class="n">ind_d</span><span class="p">:</span>
                <span class="n">ind_p2</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_p3d_ons</span> <span class="o">&gt;</span> <span class="n">ind_d</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
                <span class="n">ind_p2</span> <span class="o">=</span> <span class="n">aux_p3d_ons</span><span class="p">[</span><span class="n">ind_p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ind_p2</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_p3d_ons</span> <span class="o">&lt;</span> <span class="n">ind_d</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
                <span class="n">ind_p2</span> <span class="o">=</span> <span class="n">aux_p3d_ons</span><span class="p">[</span><span class="n">ind_p2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_dic</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">aux_x_pks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">ibi_portion</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ind_p2</span> <span class="o">&gt;</span> <span class="n">ind_dic</span> <span class="o">-</span> <span class="n">start</span><span class="p">:</span>
                    <span class="n">ind_between</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_x_pks</span> <span class="o">&lt;</span> <span class="n">ind_p2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_x_pks</span> <span class="o">&gt;</span> <span class="n">ind_dic</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ind_between</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_x_pks</span> <span class="o">&gt;</span> <span class="n">ind_p2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">aux_x_pks</span> <span class="o">&lt;</span> <span class="n">ind_dic</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_between</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ind_p2</span> <span class="o">=</span> <span class="n">aux_x_pks</span><span class="p">[</span><span class="n">ind_between</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">p2p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p2p</span><span class="p">,</span> <span class="n">ind_p2</span> <span class="o">+</span> <span class="n">start</span><span class="p">)</span>
            <span class="c1">#plt.scatter(ind_p2, ibi_3d_portion[ind_p2]/np.max(ibi_3d_portion), marker = &#39;o&#39;)</span>
    <span class="n">p1p</span> <span class="o">=</span> <span class="n">p1p</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">p2p</span> <span class="o">=</span> <span class="n">p2p</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1">#plt.figure()</span>
    <span class="c1">#plt.plot(d3x, color = &#39;black&#39;)</span>
    <span class="c1">#plt.scatter(p1p, d3x[p1p], marker = &#39;o&#39;, color = &#39;green&#39;)</span>
    <span class="c1">#plt.scatter(p2p, d3x[p2p], marker = &#39;o&#39;, color = &#39;orange&#39;)</span>

    <span class="c1"># Added by PC: Magnitudes of second derivative points</span>
    <span class="n">bmag2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b2d</span><span class="p">))</span>
    <span class="n">cmag2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b2d</span><span class="p">))</span>
    <span class="n">dmag2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b2d</span><span class="p">))</span>
    <span class="n">emag2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b2d</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">beat_no</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">d2d</span><span class="p">)):</span>
        <span class="n">bmag2d</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2x</span><span class="p">[</span><span class="n">b2d</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]]</span><span class="o">/</span><span class="n">d2x</span><span class="p">[</span><span class="n">a2d</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]]</span>
        <span class="n">cmag2d</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2x</span><span class="p">[</span><span class="n">c2d</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]]</span><span class="o">/</span><span class="n">d2x</span><span class="p">[</span><span class="n">a2d</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]]</span>
        <span class="n">dmag2d</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2x</span><span class="p">[</span><span class="n">d2d</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]]</span><span class="o">/</span><span class="n">d2x</span><span class="p">[</span><span class="n">a2d</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]]</span>
        <span class="n">emag2d</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2x</span><span class="p">[</span><span class="n">e2d</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]]</span><span class="o">/</span><span class="n">d2x</span><span class="p">[</span><span class="n">a2d</span><span class="p">[</span><span class="n">beat_no</span><span class="p">]]</span>

     <span class="c1"># Added by PC: Refine the list of fiducial points to only include those corresponding to beats for which a full set of points is available</span>
    <span class="n">off</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">ons</span> <span class="o">=</span> <span class="n">ons</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">pks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ons</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="n">pks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">pks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">off</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">pks</span> <span class="o">=</span> <span class="n">pks</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Visualise results</span>
    <span class="k">if</span> <span class="n">vis</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">ax3</span><span class="p">,</span><span class="n">ax4</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Fiducial points&#39;</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pks</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">pks</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;pks&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ons</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">ons</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;ons&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">off</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dia</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">dia</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;dia&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">dic</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;dic&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tip</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">tip</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;dic&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d1x</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">m1d</span><span class="p">,</span> <span class="n">d1x</span><span class="p">[</span><span class="n">m1d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;m1d&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;d1x&#39;</span><span class="p">)</span>

        <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d2x</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">a2d</span><span class="p">,</span> <span class="n">d2x</span><span class="p">[</span><span class="n">a2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b2d</span><span class="p">,</span> <span class="n">d2x</span><span class="p">[</span><span class="n">b2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">c2d</span><span class="p">,</span> <span class="n">d2x</span><span class="p">[</span><span class="n">c2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">d2d</span><span class="p">,</span> <span class="n">d2x</span><span class="p">[</span><span class="n">d2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">e2d</span><span class="p">,</span> <span class="n">d2x</span><span class="p">[</span><span class="n">e2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;e&#39;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;d2x&#39;</span><span class="p">)</span>

        <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d3x</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">p1p</span><span class="p">,</span> <span class="n">d3x</span><span class="p">[</span><span class="n">p1p</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;p1&#39;</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">p2p</span><span class="p">,</span> <span class="n">d3x</span><span class="p">[</span><span class="n">p2p</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)],</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;p2&#39;</span><span class="p">)</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;d3x&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                            <span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                            <span class="n">right</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
                            <span class="n">top</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
                            <span class="n">wspace</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>
                            <span class="n">hspace</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">)</span>

    <span class="c1"># Creation of dictionary</span>
    <span class="n">fidp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pks&#39;</span><span class="p">:</span> <span class="n">pks</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;ons&#39;</span><span class="p">:</span> <span class="n">ons</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;off&#39;</span><span class="p">:</span> <span class="n">off</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>  <span class="c1"># Added by PC</span>
            <span class="s1">&#39;tip&#39;</span><span class="p">:</span> <span class="n">tip</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;dia&#39;</span><span class="p">:</span> <span class="n">dia</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;dic&#39;</span><span class="p">:</span> <span class="n">dic</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;m1d&#39;</span><span class="p">:</span> <span class="n">m1d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;a2d&#39;</span><span class="p">:</span> <span class="n">a2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;b2d&#39;</span><span class="p">:</span> <span class="n">b2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;c2d&#39;</span><span class="p">:</span> <span class="n">c2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;d2d&#39;</span><span class="p">:</span> <span class="n">d2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;e2d&#39;</span><span class="p">:</span> <span class="n">e2d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;bmag2d&#39;</span><span class="p">:</span> <span class="n">bmag2d</span><span class="p">,</span>
            <span class="s1">&#39;cmag2d&#39;</span><span class="p">:</span> <span class="n">cmag2d</span><span class="p">,</span>
            <span class="s1">&#39;dmag2d&#39;</span><span class="p">:</span> <span class="n">dmag2d</span><span class="p">,</span>
            <span class="s1">&#39;emag2d&#39;</span><span class="p">:</span> <span class="n">emag2d</span><span class="p">,</span>
            <span class="s1">&#39;p1p&#39;</span><span class="p">:</span> <span class="n">p1p</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="s1">&#39;p2p&#39;</span><span class="p">:</span> <span class="n">p2p</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="n">fidp</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./tutorial/notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="pulse-wave-analysis.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Pulse Wave Analysis</p>
      </div>
    </a>
    <a class="right-next"
       href="../../case-study.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Case Study</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extract-one-minute-of-abp-signal-from-this-segment">Extract one minute of ABP signal from this segment</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#derive-bp-values">Derive BP values</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#detect-beats-in-the-bp-signal">Detect beats in the BP signal</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#detect-pulse-onsets-and-peaks">Detect pulse onsets and peaks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-bp-values">Calculate BP values</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#beat-detection-functions">Beat Detection Functions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#fiducial-point-functions">Fiducial Point functions</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Peter H Charlton
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>